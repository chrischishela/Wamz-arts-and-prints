<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Make Sale - Wamz Arts & Prints</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 14px;
        }

        /* HEADER - Mobile Optimized */
        .header {
            background: #1a365d;
            color: white;
            padding: 0.8rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .header h1 {
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.8rem;
        }

        .user-name {
            font-weight: 500;
            color: #e2e8f0;
            font-size: 0.8rem;
        }

        .branch-badge {
            background: #4299e1;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .logout-btn {
            background: #2d3748;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        /* MAIN CONTAINER - Full width for mobile */
        .main-container {
            width: 100%;
            padding: 0 0.5rem;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 110px);
        }

        /* BACK BUTTON */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            margin-bottom: 0.8rem;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
            touch-action: manipulation;
        }

        /* SALE CONTAINER - Stack vertically on mobile */
        .sale-container {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            flex: 1;
            min-height: 0;
            width: 100%;
        }

        /* INVENTORY SECTION - Mobile optimized */
        .inventory-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1;
            min-height: 40vh;
        }

        .section-header {
            padding: 0.8rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .section-header h3 {
            font-size: 0.9rem;
            color: #2d3748;
            font-weight: 600;
        }

        .search-controls {
            display: flex;
            gap: 0.4rem;
            padding: 0.8rem;
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .search-input {
            flex: 1;
            padding: 0.6rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.85rem;
            min-height: 40px;
        }

        .search-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 60px;
            min-height: 40px;
        }

        /* INVENTORY TABLE - Mobile scrollable */
        .table-container {
            flex: 1;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
            width: 100%;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            min-width: 700px; /* Allows horizontal scroll on small screens */
        }

        .inventory-table th {
            background: #f8fafc;
            padding: 0.6rem;
            text-align: left;
            color: #718096;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 1;
            white-space: nowrap;
        }

        .inventory-table td {
            padding: 0.6rem;
            border-bottom: 1px solid #f7fafc;
            color: #4a5568;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .code-badge {
            background: #4299e1;
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            font-family: monospace;
            display: inline-block;
        }

        .qty-input {
            width: 50px;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            text-align: center;
            font-size: 0.85rem;
            min-height: 36px;
        }

        .add-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-height: 36px;
        }

        /* CART SECTION - Mobile optimized */
        .cart-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1;
            min-height: 40vh;
        }

        .cart-header {
            padding: 0.8rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .cart-header h3 {
            font-size: 0.9rem;
            color: #2d3748;
            font-weight: 600;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 0.8rem;
            min-height: 150px;
            -webkit-overflow-scrolling: touch;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            border-bottom: 1px solid #f7fafc;
            margin-bottom: 0.5rem;
            background: #f8fafc;
            border-radius: 8px;
            gap: 0.5rem;
        }

        .cart-item-info {
            flex: 1;
            min-width: 0; /* Allows text truncation */
        }

        .cart-item-info div:first-child {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cart-item-info div:last-child {
            font-size: 0.7rem;
            color: #718096;
            white-space: nowrap;
        }

        .cart-item-controls {
            display: flex;
            gap: 0.3rem;
            align-items: center;
            flex-shrink: 0;
        }

        .cart-item-btn {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .remove-btn {
            background: #fed7d7;
            color: #c53030;
        }

        /* CART SUMMARY - Mobile optimized */
        .cart-summary {
            padding: 1rem;
            border-top: 2px solid #e2e8f0;
            background: #f8fafc;
            flex-shrink: 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .total-row {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e2e8f0;
        }

        .discount-controls {
            display: flex;
            gap: 0.4rem;
            margin: 0.8rem 0;
            align-items: center;
        }

        .discount-select, .discount-input, .customer-input {
            padding: 0.6rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.85rem;
            min-height: 40px;
        }

        .discount-select {
            flex: 1;
        }

        .discount-input {
            flex: 1;
        }

        .customer-input {
            width: 100%;
            margin-top: 0.8rem;
        }

        /* CART ACTIONS - Stack buttons on mobile */
        .cart-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .cart-action-btn {
            flex: 1;
            padding: 0.8rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-height: 44px;
            touch-action: manipulation;
        }

        .checkout-btn {
            background: #38a169;
            color: white;
        }

        .checkout-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .clear-btn {
            background: #e2e8f0;
            color: #4a5568;
        }

        /* MESSAGE DISPLAY */
        .message {
            padding: 0.8rem;
            border-radius: 8px;
            margin-bottom: 0.8rem;
            display: none;
            border: 1px solid transparent;
            font-size: 0.85rem;
        }

        .message.success {
            background: #f0fff4;
            color: #276749;
            border-color: #c6f6d5;
        }

        .message.error {
            background: #fff5f5;
            color: #c53030;
            border-color: #fed7d7;
        }

        /* FIXED CART BAR FOR SMALL SCREENS */
        .mobile-cart-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e2e8f0;
            padding: 0.8rem;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .mobile-cart-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .mobile-cart-total {
            font-weight: 600;
            color: #2d3748;
        }

        /* LOADING STATES */
        .loading {
            color: #a0aec0;
            font-style: italic;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* TOUCH FRIENDLY STYLES */
        @media (hover: none) and (pointer: coarse) {
            button, 
            input[type="number"],
            select {
                min-height: 44px; /* Larger touch targets */
            }
            
            .cart-item-btn {
                width: 32px;
                height: 32px;
            }
            
            .add-btn {
                padding: 0.6rem 1rem;
            }
        }

        /* RESPONSIVE DESIGN */
        @media (min-width: 768px) {
            .header {
                flex-direction: row;
                align-items: center;
            }
            
            .header-top {
                margin-bottom: 0;
                flex: 1;
            }
            
            .sale-container {
                flex-direction: row;
            }
            
            .inventory-section {
                min-height: 70vh;
                max-height: 80vh;
            }
            
            .cart-section {
                min-height: 70vh;
                max-height: 80vh;
            }
            
            .back-btn {
                width: auto;
                justify-content: flex-start;
            }
            
            .mobile-cart-bar {
                display: none !important;
            }
        }

        @media (max-width: 767px) {
            .header h1 {
                font-size: 0.9rem;
            }
            
            .user-info {
                flex-wrap: wrap;
                justify-content: flex-end;
            }
            
            .inventory-table {
                font-size: 0.7rem;
            }
            
            .cart-items {
                max-height: 40vh;
            }
            
            /* Show mobile cart bar */
            .mobile-cart-bar {
                display: block;
            }
            
            /* Adjust main container for mobile cart bar */
            .main-container {
                min-height: calc(100vh - 160px);
                padding-bottom: 80px;
            }
            
            /* Make discount controls stack vertically */
            .discount-controls {
                flex-direction: column;
            }
            
            .cart-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0.6rem;
            }
            
            .header h1 {
                font-size: 0.85rem;
                max-width: 50%;
            }
            
            .user-name {
                display: none;
            }
            
            .branch-badge {
                font-size: 0.65rem;
            }
            
            .logout-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.75rem;
            }
            
            .search-controls {
                flex-direction: column;
            }
            
            .inventory-table th,
            .inventory-table td {
                padding: 0.4rem;
                font-size: 0.7rem;
            }
            
            .cart-item {
                padding: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-top">
            <h1>Wamz Arts & Prints - Make Sale</h1>
            <div class="user-info">
                <span class="user-name">Welcome, <strong id="currentUser">User</strong></span>
                <span class="branch-badge" id="branchBadge">Branch</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Back Button -->
        <a href="sales.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Back to Sales Dashboard
        </a>

        <!-- Message Display -->
        <div class="message" id="message"></div>

        <!-- Sale Container -->
        <div class="sale-container">
            <!-- Inventory Section -->
            <div class="inventory-section">
                <div class="section-header">
                    <h3>Available Items</h3>
                    <div>
                        <button class="search-btn" id="refreshBtn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="search-controls">
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="Search by name, code, or location...">
                    <button class="search-btn" id="searchBtn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="inventory-table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Item</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Price</th>
                                <th>Location</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 30px;">
                                    <span class="loading">Loading inventory...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Cart Section -->
            <div class="cart-section">
                <div class="cart-header">
                    <h3>Shopping Cart</h3>
                    <span id="cartIndicator" style="color: #718096; font-size: 0.8rem;">0 items</span>
                </div>
                
                <div class="cart-items" id="cartList">
                    <div style="text-align: center; padding: 2rem; color: #a0aec0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <div>Your cart is empty</div>
                        <div style="font-size: 0.75rem; margin-top: 0.5rem;">Add items from the inventory</div>
                    </div>
                </div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotalDisplay">ZMW 0.00</span>
                    </div>
                    
                    <div class="discount-controls">
                        <select class="discount-select" id="discountType">
                            <option value="none">No Discount</option>
                            <option value="percent">Percentage (%)</option>
                            <option value="fixed">Fixed Amount</option>
                        </select>
                        <input type="number" class="discount-input" id="discountValue" 
                               placeholder="0" min="0" step="0.01" disabled>
                    </div>
                    <div id="discountAmountDisplay" style="text-align: right; color: #718096; font-size: 0.8rem;">
                        -
                    </div>
                    
                    <div class="summary-row total-row">
                        <span>TOTAL:</span>
                        <span id="totalDisplay">ZMW 0.00</span>
                    </div>
                    
                    <input type="text" class="customer-input" id="customerInput" 
                           placeholder="Customer name (optional)">
                    
                    <div class="cart-actions">
                        <button class="cart-action-btn clear-btn" id="clearCartBtn">
                            Clear Cart
                        </button>
                        <button class="cart-action-btn checkout-btn" id="checkoutBtn" disabled>
                            Complete Sale
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Cart Bar (shown on small screens) -->
    <div class="mobile-cart-bar" id="mobileCartBar">
        <div class="mobile-cart-summary">
            <div>
                <div style="font-size: 0.8rem; color: #718096;" id="mobileCartIndicator">0 items</div>
                <div class="mobile-cart-total" id="mobileTotalDisplay">ZMW 0.00</div>
            </div>
            <button class="cart-action-btn checkout-btn" id="mobileCheckoutBtn" disabled style="min-width: 120px;">
                Checkout
            </button>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDTslfW2YQOw1XqiTn4RgTNKusi4w6NcHI",
            authDomain: "wamz-arts-and-prints.firebaseapp.com",
            projectId: "wamz-arts-and-prints",
            storageBucket: "wamz-arts-and-prints.firebasestorage.app",
            messagingSenderId: "495100135771",
            appId: "1:495100135771:web:d63ab48db021b4b02c327e",
            measurementId: "G-1HL55EC1D1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;
        
        let currentUserData = null;
        let currentBranch = '';
        let allItems = [];
        let cart = [];
        let unsubscribeInventory = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üõí Make Sale page loaded - Mobile Optimized");
            checkLogin();
            
            // Prevent zoom on mobile
            document.addEventListener('touchstart', function(event) {
                if (event.touches.length > 1) {
                    event.preventDefault();
                }
            }, { passive: false });
        });

        // Check login
        function checkLogin() {
            const currentUser = localStorage.getItem('currentUser');
            
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            currentUserData = JSON.parse(currentUser);
            const username = currentUserData.username;
            
            // Set welcome message
            document.getElementById('currentUser').textContent = username;
            
            // Assign branches
            if (username === 'Samz') {
                currentBranch = 'branch2';
                document.getElementById('branchBadge').textContent = 'Branch 2';
            } else if (username === 'Namz') {
                currentBranch = 'branch3';
                document.getElementById('branchBadge').textContent = 'Branch 3';
            } else if (username === 'Wamz') {
                currentBranch = 'branch1';
                document.getElementById('branchBadge').textContent = 'Branch 1';
            } else {
                currentBranch = 'unassigned';
                document.getElementById('branchBadge').textContent = 'Unassigned';
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Load inventory
            setupInventoryListener();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchBtn').addEventListener('click', searchItems);
            document.getElementById('searchInput').addEventListener('input', searchItems);
            document.getElementById('refreshBtn').addEventListener('click', refreshItems);
            
            // Cart functionality
            document.getElementById('clearCartBtn').addEventListener('click', clearCart);
            document.getElementById('checkoutBtn').addEventListener('click', checkout);
            document.getElementById('mobileCheckoutBtn').addEventListener('click', checkout);
            
            // Discount functionality
            document.getElementById('discountType').addEventListener('change', function() {
                document.getElementById('discountValue').disabled = this.value === 'none';
                renderCart();
            });
            document.getElementById('discountValue').addEventListener('input', renderCart);
            
            // Prevent form submission on enter
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                }
            });
        }

        // Format currency
        function formatCurrency(amount) {
            const num = parseFloat(amount) || 0;
            return 'ZMW ' + num.toFixed(2);
        }

        // Setup inventory listener
        function setupInventoryListener() {
            console.log(`üì¶ Setting up inventory listener for branch: ${currentBranch}`);
            
            // Unsubscribe from previous listener if exists
            if (unsubscribeInventory) {
                unsubscribeInventory();
            }
            
            // Query Firestore for items in this branch
            const q = db.collection('inventory').where('branchId', '==', currentBranch);
            
            unsubscribeInventory = q.onSnapshot((snapshot) => {
                console.log(`üì¶ Inventory update received:`, snapshot.size, "items");
                
                allItems = [];
                
                if (snapshot.empty) {
                    const inventoryBody = document.getElementById('inventoryBody');
                    inventoryBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px;">
                                <div style="color: #666; font-size: 12px;">
                                    üì≠ No items in inventory
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Process all items
                snapshot.forEach((doc) => {
                    const item = doc.data();
                    item.id = doc.id;
                    
                    // Get sale price for calculations
                    item.price = parseFloat(item.salePrice || item.price) || 0;
                    item.stock = parseInt(item.stock) || 0;
                    
                    allItems.push(item);
                });
                
                // Load inventory for display
                loadInventoryForSale();
                
            }, (error) => {
                console.error("‚ùå Inventory listener error:", error);
                const inventoryBody = document.getElementById('inventoryBody');
                inventoryBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #c53030;">
                            ‚ùå Error loading inventory
                        </td>
                    </tr>
                `;
            });
        }

        // Load inventory for sale display
        function loadInventoryForSale() {
            const inventoryBody = document.getElementById('inventoryBody');
            inventoryBody.innerHTML = '';
            
            allItems.forEach(item => {
                const row = inventoryBody.insertRow();
                
                // Determine if item can be added to cart
                const canAdd = item.stock > 0;
                
                row.innerHTML = `
                    <td><span class="code-badge">${escapeHtml(item.code || '')}</span></td>
                    <td><strong>${escapeHtml(item.name || '')}</strong></td>
                    <td>${getCategoryName(item.category)}</td>
                    <td>${item.stock}</td>
                    <td><strong>${formatCurrency(item.price)}</strong></td>
                    <td>${escapeHtml(item.location || '')}</td>
                    <td>
                        <div style="display: flex; gap: 0.4rem; align-items: center;">
                            <input type="number" class="qty-input" id="qty-${item.id}" 
                                   value="1" min="1" max="${item.stock}" ${!canAdd ? 'disabled' : ''}>
                            <button class="add-btn" data-id="${item.id}" ${!canAdd ? 'disabled' : ''}>
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </td>
                `;
            });
            
            // Add event listeners to add buttons
            inventoryBody.querySelectorAll('button[data-id]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    const qtyInput = document.getElementById(`qty-${itemId}`);
                    const quantity = parseInt(qtyInput.value) || 1;
                    
                    addToCart(itemId, quantity);
                    
                    // Reset quantity input to 1
                    qtyInput.value = 1;
                    
                    // Show feedback
                    const item = allItems.find(i => i.id === itemId);
                    if (item) {
                        showMessage(`Added ${quantity} √ó ${item.name}`, 'success');
                    }
                });
            });
        }

        // Get category display name
        function getCategoryName(categoryCode) {
            const categories = {
                'phone accessories': 'Phone Acc',
                'stationary': 'Stationary',
                'other suppliers': 'Other',
                'paper': 'Paper',
                'ink': 'Ink & Toner',
                'frames': 'Frames',
                'printing': 'Printing',
                'art': 'Art Supplies',
                'other': 'Other'
            };
            return categories[categoryCode] || categoryCode || '-';
        }

        // Search items
        function searchItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                loadInventoryForSale();
                return;
            }
            
            const filteredItems = allItems.filter(item => {
                return (
                    (item.name || '').toLowerCase().includes(searchTerm) ||
                    (item.code || '').toLowerCase().includes(searchTerm) ||
                    (item.location || '').toLowerCase().includes(searchTerm) ||
                    getCategoryName(item.category).toLowerCase().includes(searchTerm)
                );
            });
            
            const inventoryBody = document.getElementById('inventoryBody');
            inventoryBody.innerHTML = '';
            
            if (filteredItems.length === 0) {
                inventoryBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px;">
                            No items found for "${searchTerm}"
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Display filtered items
            filteredItems.forEach(item => {
                const row = inventoryBody.insertRow();
                const canAdd = item.stock > 0;
                
                row.innerHTML = `
                    <td><span class="code-badge">${escapeHtml(item.code || '')}</span></td>
                    <td><strong>${escapeHtml(item.name || '')}</strong></td>
                    <td>${getCategoryName(item.category)}</td>
                    <td>${item.stock}</td>
                    <td><strong>${formatCurrency(item.price)}</strong></td>
                    <td>${escapeHtml(item.location || '')}</td>
                    <td>
                        <div style="display: flex; gap: 0.4rem; align-items: center;">
                            <input type="number" class="qty-input" id="qty-${item.id}" 
                                   value="1" min="1" max="${item.stock}" ${!canAdd ? 'disabled' : ''}>
                            <button class="add-btn" data-id="${item.id}" ${!canAdd ? 'disabled' : ''}>
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </td>
                `;
            });
            
            // Re-add event listeners
            inventoryBody.querySelectorAll('button[data-id]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    const qtyInput = document.getElementById(`qty-${itemId}`);
                    const quantity = parseInt(qtyInput.value) || 1;
                    
                    addToCart(itemId, quantity);
                    
                    // Reset quantity input to 1
                    qtyInput.value = 1;
                    
                    // Show feedback
                    const item = allItems.find(i => i.id === itemId);
                    if (item) {
                        showMessage(`Added ${quantity} √ó ${item.name}`, 'success');
                    }
                });
            });
        }

        // Refresh items
        function refreshItems() {
            document.getElementById('searchInput').value = '';
            loadInventoryForSale();
            showMessage('Inventory refreshed', 'success');
        }

        // Add to cart
        function addToCart(itemId, quantity) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) {
                showMessage('Item not found', 'error');
                return;
            }
            
            if (quantity <= 0) {
                showMessage('Quantity must be at least 1', 'error');
                return;
            }
            
            if (quantity > item.stock) {
                showMessage(`Only ${item.stock} items available`, 'error');
                return;
            }
            
            // Check if item already in cart
            const existingItemIndex = cart.findIndex(cartItem => cartItem.id === itemId);
            
            if (existingItemIndex > -1) {
                // Update existing item
                const newQuantity = cart[existingItemIndex].quantity + quantity;
                if (newQuantity > item.stock) {
                    showMessage(`Cannot add ${quantity} more. Total would exceed available stock.`, 'error');
                    return;
                }
                cart[existingItemIndex].quantity = newQuantity;
                cart[existingItemIndex].subtotal = newQuantity * item.price;
            } else {
                // Add new item to cart
                cart.push({
                    id: itemId,
                    code: item.code,
                    name: item.name,
                    price: item.price,
                    orderPrice: item.orderPrice || 0,
                    quantity: quantity,
                    subtotal: quantity * item.price
                });
            }
            
            renderCart();
        }

        // Render cart
        function renderCart() {
            const cartList = document.getElementById('cartList');
            const cartIndicator = document.getElementById('cartIndicator');
            const mobileCartIndicator = document.getElementById('mobileCartIndicator');
            const subtotalDisplay = document.getElementById('subtotalDisplay');
            const totalDisplay = document.getElementById('totalDisplay');
            const mobileTotalDisplay = document.getElementById('mobileTotalDisplay');
            const discountAmountDisplay = document.getElementById('discountAmountDisplay');
            const checkoutBtn = document.getElementById('checkoutBtn');
            const mobileCheckoutBtn = document.getElementById('mobileCheckoutBtn');
            
            if (cart.length === 0) {
                cartList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #a0aec0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <div>Your cart is empty</div>
                        <div style="font-size: 0.75rem; margin-top: 0.5rem;">Add items from the inventory</div>
                    </div>
                `;
                cartIndicator.textContent = '0 items';
                mobileCartIndicator.textContent = '0 items';
                subtotalDisplay.textContent = formatCurrency(0);
                totalDisplay.textContent = formatCurrency(0);
                mobileTotalDisplay.textContent = formatCurrency(0);
                discountAmountDisplay.textContent = '-';
                checkoutBtn.disabled = true;
                mobileCheckoutBtn.disabled = true;
                return;
            }
            
            // Calculate subtotal
            const subtotal = cart.reduce((sum, item) => sum + item.subtotal, 0);
            
            // Calculate discount
            const discountType = document.getElementById('discountType').value;
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            let discountAmount = 0;
            
            if (discountType === 'percent') {
                discountAmount = (subtotal * discountValue) / 100;
            } else if (discountType === 'fixed') {
                discountAmount = Math.min(discountValue, subtotal);
            }
            
            // Calculate total
            const total = Math.max(0, subtotal - discountAmount);
            
            // Update displays
            subtotalDisplay.textContent = formatCurrency(subtotal);
            totalDisplay.textContent = formatCurrency(total);
            mobileTotalDisplay.textContent = formatCurrency(total);
            discountAmountDisplay.textContent = discountAmount > 0 ? `-${formatCurrency(discountAmount)}` : '-';
            
            // Update cart indicator
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartIndicator.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
            mobileCartIndicator.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
            
            // Render cart items
            cartList.innerHTML = '';
            cart.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <div class="cart-item-info">
                        <div>${escapeHtml(item.name)}</div>
                        <div>${escapeHtml(item.code)} ‚Ä¢ ${formatCurrency(item.price)}</div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="cart-item-btn" data-action="decrease" data-index="${index}">-</button>
                        <span style="min-width: 30px; text-align: center; font-weight: 600;">${item.quantity}</span>
                        <button class="cart-item-btn" data-action="increase" data-index="${index}">+</button>
                        <button class="cart-item-btn remove-btn" data-action="remove" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                cartList.appendChild(itemDiv);
            });
            
            // Add event listeners to cart controls
            cartList.querySelectorAll('.cart-item-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    const index = parseInt(this.getAttribute('data-index'));
                    updateCartItem(index, action);
                });
            });
            
            checkoutBtn.disabled = false;
            mobileCheckoutBtn.disabled = false;
        }

        // Update cart item
        function updateCartItem(index, action) {
            if (index < 0 || index >= cart.length) return;
            
            const item = cart[index];
            const inventoryItem = allItems.find(i => i.id === item.id);
            
            switch(action) {
                case 'increase':
                    if (item.quantity + 1 > inventoryItem.stock) {
                        showMessage(`Only ${inventoryItem.stock} items available`, 'error');
                        return;
                    }
                    item.quantity++;
                    item.subtotal = item.quantity * item.price;
                    break;
                    
                case 'decrease':
                    if (item.quantity > 1) {
                        item.quantity--;
                        item.subtotal = item.quantity * item.price;
                    } else {
                        cart.splice(index, 1);
                        showMessage(`${item.name} removed from cart`, 'info');
                    }
                    break;
                    
                case 'remove':
                    cart.splice(index, 1);
                    showMessage(`${item.name} removed from cart`, 'info');
                    break;
            }
            
            renderCart();
        }

        // Clear cart
        function clearCart() {
            if (cart.length === 0) return;
            
            if (confirm('Clear all items from cart?')) {
                cart = [];
                renderCart();
                showMessage('Cart cleared', 'info');
            }
        }

        // Checkout
        async function checkout() {
            if (cart.length === 0) {
                showMessage('Cart is empty', 'error');
                return;
            }
            
            // Check stock availability before proceeding
            let stockError = false;
            for (const cartItem of cart) {
                const inventoryItem = allItems.find(i => i.id === cartItem.id);
                if (!inventoryItem || cartItem.quantity > inventoryItem.stock) {
                    showMessage(`${cartItem.name} is out of stock`, 'error');
                    stockError = true;
                }
            }
            
            if (stockError) return;
            
            if (!confirm('Process sale?')) {
                return;
            }
            
            try {
                // Calculate totals
                const subtotal = cart.reduce((sum, item) => sum + item.subtotal, 0);
                const discountType = document.getElementById('discountType').value;
                const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
                let discountAmount = 0;
                
                if (discountType === 'percent') {
                    discountAmount = (subtotal * discountValue) / 100;
                } else if (discountType === 'fixed') {
                    discountAmount = Math.min(discountValue, subtotal);
                }
                
                const total = Math.max(0, subtotal - discountAmount);
                const customerName = document.getElementById('customerInput').value.trim() || 'Walk-in';
                
                // Create sale record
                const sale = {
                    customerName: customerName,
                    items: cart.map(item => ({
                        itemId: item.id,
                        code: item.code,
                        name: item.name,
                        price: item.price,
                        cost: item.orderPrice,
                        quantity: item.quantity,
                        subtotal: item.subtotal,
                        costTotal: item.quantity * item.orderPrice
                    })),
                    subtotal: subtotal,
                    discount: {
                        type: discountType,
                        value: discountValue,
                        amount: discountAmount
                    },
                    total: total,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    processedBy: currentUserData.username,
                    branchId: currentBranch,
                    status: 'completed'
                };
                
                // Save to Firestore
                const saleRef = await db.collection('sales').add(sale);
                
                // Update inventory for each item
                const updatePromises = cart.map(item => {
                    const itemRef = db.collection('inventory').doc(item.id);
                    return itemRef.update({
                        stock: FieldValue.increment(-item.quantity),
                        sold: FieldValue.increment(item.quantity)
                    });
                });
                
                await Promise.all(updatePromises);
                
                // Show success message
                showMessage(`‚úÖ Sale completed! Total: ${formatCurrency(total)}`, 'success');
                
                // Clear cart and reset form
                cart = [];
                document.getElementById('customerInput').value = '';
                document.getElementById('discountType').value = 'none';
                document.getElementById('discountValue').value = '';
                document.getElementById('discountValue').disabled = true;
                
                renderCart();
                
                // Redirect back to sales dashboard after 2 seconds
                setTimeout(() => {
                    window.location.href = 'sales.html';
                }, 2000);
                
            } catch (error) {
                console.error('Checkout error:', error);
                showMessage('Error processing sale: ' + error.message, 'error');
            }
        }

        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';

            // Auto-hide after 4 seconds
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 4000);
        }

        // Logout function
        function logout() {
            // Unsubscribe from Firestore listeners
            if (unsubscribeInventory) {
                unsubscribeInventory();
            }

            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
