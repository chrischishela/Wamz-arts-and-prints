<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make Sale - Wamz Arts & Prints</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.5;
            min-height: 100vh;
        }

        /* HEADER */
        .header {
            background: #1a365d;
            color: white;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .user-name {
            font-weight: 500;
            color: #e2e8f0;
            font-size: 0.85rem;
        }

        .branch-badge {
            background: #4299e1;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .logout-btn {
            background: #2d3748;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #4a5568;
        }

        /* BACK BUTTON */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #3182ce;
            transform: translateX(-2px);
        }

        /* MAIN CONTAINER */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
        }

        /* SALE CONTAINER */
        .sale-container {
            display: flex;
            gap: 1rem;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* INVENTORY SECTION */
        .inventory-section {
            flex: 2;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .section-header {
            padding: 0.8rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .section-header h3 {
            font-size: 0.9rem;
            color: #2d3748;
            font-weight: 600;
        }

        .search-controls {
            display: flex;
            gap: 0.4rem;
            padding: 0.8rem;
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .search-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .search-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #3182ce;
        }

        /* INVENTORY TABLE */
        .table-container {
            flex: 1;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .inventory-table th {
            background: #f8fafc;
            padding: 0.6rem;
            text-align: left;
            color: #718096;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .inventory-table td {
            padding: 0.6rem;
            border-bottom: 1px solid #f7fafc;
            color: #4a5568;
            font-size: 0.75rem;
        }

        .inventory-table tr:hover {
            background: #f8fafc;
        }

        .code-badge {
            background: #4299e1;
            color: white;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
            font-family: monospace;
            display: inline-block;
        }

        .qty-input {
            width: 60px;
            padding: 0.4rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            text-align: center;
            font-size: 0.8rem;
        }

        .add-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            background: #3182ce;
        }

        /* CART SECTION */
        .cart-section {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 350px;
        }

        .cart-header {
            padding: 0.8rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .cart-header h3 {
            font-size: 0.9rem;
            color: #2d3748;
            font-weight: 600;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 0.8rem;
            min-height: 200px;
            -webkit-overflow-scrolling: touch;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem;
            border-bottom: 1px solid #f7fafc;
            margin-bottom: 0.5rem;
            background: #f8fafc;
            border-radius: 6px;
        }

        .cart-item:last-child {
            margin-bottom: 0;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-controls {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }

        .cart-item-btn {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-item-btn:hover {
            background: #cbd5e0;
        }

        .remove-btn {
            background: #fed7d7;
            color: #c53030;
        }

        .remove-btn:hover {
            background: #feb2b2;
        }

        /* CART SUMMARY */
        .cart-summary {
            padding: 0.8rem;
            border-top: 2px solid #e2e8f0;
            background: #f8fafc;
            flex-shrink: 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
            font-size: 0.8rem;
        }

        .total-row {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2d3748;
            margin-top: 0.3rem;
            padding-top: 0.3rem;
            border-top: 1px solid #e2e8f0;
        }

        .discount-controls {
            display: flex;
            gap: 0.3rem;
            margin: 0.6rem 0;
            align-items: center;
        }

        .discount-select {
            flex: 1;
            padding: 0.4rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .discount-input {
            flex: 1;
            padding: 0.4rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .customer-input {
            width: 100%;
            padding: 0.6rem;
            margin-top: 0.6rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        /* CART ACTIONS */
        .cart-actions {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.8rem;
        }

        .cart-action-btn {
            flex: 1;
            padding: 0.6rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .checkout-btn {
            background: #38a169;
            color: white;
        }

        .checkout-btn:hover {
            background: #2f855a;
        }

        .checkout-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .clear-btn {
            background: #e2e8f0;
            color: #4a5568;
        }

        .clear-btn:hover {
            background: #cbd5e0;
        }

        /* MESSAGE DISPLAY */
        .message {
            padding: 0.6rem;
            border-radius: 6px;
            margin-bottom: 0.8rem;
            display: none;
            border: 1px solid transparent;
            font-size: 0.8rem;
        }

        .message.success {
            background: #f0fff4;
            color: #276749;
            border-color: #c6f6d5;
        }

        .message.error {
            background: #fff5f5;
            color: #c53030;
            border-color: #fed7d7;
        }

        .message.info {
            background: #ebf8ff;
            color: #2c5282;
            border-color: #bee3f8;
        }

        /* LOADING STATES */
        .loading {
            color: #a0aec0;
            font-style: italic;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 1024px) {
            .sale-container {
                flex-direction: column;
            }
            
            .cart-section {
                min-width: 100%;
            }
            
            .inventory-section,
            .cart-section {
                flex: none;
                height: 50%;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 0.8rem;
                text-align: center;
            }
            
            .header-left {
                flex-direction: column;
            }
            
            .search-controls {
                flex-direction: column;
            }
            
            .cart-actions {
                flex-direction: column;
            }
            
            .inventory-table {
                font-size: 0.7rem;
            }
            
            .inventory-table th,
            .inventory-table td {
                padding: 0.4rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>Wamz Arts & Prints - Make Sale</h1>
        </div>
        <div class="user-info">
            <span class="user-name">Welcome, <strong id="currentUser">User</strong></span>
            <span class="branch-badge" id="branchBadge">Branch</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Back Button -->
        <a href="sales.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Back to Sales Dashboard
        </a>

        <!-- Message Display -->
        <div class="message" id="message"></div>

        <!-- Sale Container -->
        <div class="sale-container">
            <!-- Inventory Section (Left Side) -->
            <div class="inventory-section">
                <div class="section-header">
                    <h3>Available Items</h3>
                    <div>
                        <button class="search-btn" id="refreshBtn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="search-controls">
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="Search by item name, code, or location...">
                    <button class="search-btn" id="searchBtn">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="inventory-table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Item</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Sale Price</th>
                                <th>Location</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 30px;">
                                    <span class="loading">Loading inventory...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Cart Section (Right Side) -->
            <div class="cart-section">
                <div class="cart-header">
                    <h3>Shopping Cart</h3>
                    <span id="cartIndicator" style="color: #718096; font-size: 0.8rem;">0 items</span>
                </div>
                
                <div class="cart-items" id="cartList">
                    <div style="text-align: center; padding: 2rem; color: #a0aec0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <div>Your cart is empty</div>
                        <div style="font-size: 0.75rem; margin-top: 0.5rem;">Add items from the inventory</div>
                    </div>
                </div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotalDisplay">ZMW 0.00</span>
                    </div>
                    
                    <div class="discount-controls">
                        <select class="discount-select" id="discountType">
                            <option value="none">No Discount</option>
                            <option value="percent">Percentage (%)</option>
                            <option value="fixed">Fixed Amount</option>
                        </select>
                        <input type="number" class="discount-input" id="discountValue" 
                               placeholder="0" min="0" step="0.01" disabled>
                    </div>
                    <div id="discountAmountDisplay" style="text-align: right; color: #718096; font-size: 0.8rem;">
                        -
                    </div>
                    
                    <div class="summary-row total-row">
                        <span>TOTAL:</span>
                        <span id="totalDisplay">ZMW 0.00</span>
                    </div>
                    
                    <input type="text" class="customer-input" id="customerInput" 
                           placeholder="Customer name (optional)">
                    
                    <div class="cart-actions">
                        <button class="cart-action-btn clear-btn" id="clearCartBtn">
                            Clear Cart
                        </button>
                        <button class="cart-action-btn checkout-btn" id="checkoutBtn" disabled>
                            Complete Sale
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDTslfW2YQOw1XqiTn4RgTNKusi4w6NcHI",
            authDomain: "wamz-arts-and-prints.firebaseapp.com",
            projectId: "wamz-arts-and-prints",
            storageBucket: "wamz-arts-and-prints.firebasestorage.app",
            messagingSenderId: "495100135771",
            appId: "1:495100135771:web:d63ab48db021b4b02c327e",
            measurementId: "G-1HL55EC1D1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;
        
        let currentUserData = null;
        let currentBranch = '';
        let allItems = [];
        let cart = [];
        let unsubscribeInventory = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üõí Make Sale page loaded");
            checkLogin();
        });

        // Check login
        function checkLogin() {
            const currentUser = localStorage.getItem('currentUser');
            
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            currentUserData = JSON.parse(currentUser);
            const username = currentUserData.username;
            
            // Set welcome message
            document.getElementById('currentUser').textContent = username;
            
            // Assign branches
            if (username === 'Samz') {
                currentBranch = 'branch2';
                document.getElementById('branchBadge').textContent = 'Branch 2';
            } else if (username === 'Namz') {
                currentBranch = 'branch3';
                document.getElementById('branchBadge').textContent = 'Branch 3';
            } else if (username === 'Wamz') {
                currentBranch = 'branch1';
                document.getElementById('branchBadge').textContent = 'Branch 1';
            } else {
                currentBranch = 'unassigned';
                document.getElementById('branchBadge').textContent = 'Unassigned';
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Load inventory
            setupInventoryListener();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchBtn').addEventListener('click', searchItems);
            document.getElementById('searchInput').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    searchItems();
                }
            });
            document.getElementById('refreshBtn').addEventListener('click', refreshItems);
            
            // Cart functionality
            document.getElementById('clearCartBtn').addEventListener('click', clearCart);
            document.getElementById('checkoutBtn').addEventListener('click', checkout);
            
            // Discount functionality
            document.getElementById('discountType').addEventListener('change', function() {
                document.getElementById('discountValue').disabled = this.value === 'none';
                renderCart();
            });
            document.getElementById('discountValue').addEventListener('input', renderCart);
        }

        // Format currency
        function formatCurrency(amount) {
            const num = parseFloat(amount) || 0;
            return 'ZMW ' + num.toFixed(2);
        }

        // Setup inventory listener
        function setupInventoryListener() {
            console.log(`üì¶ Setting up inventory listener for branch: ${currentBranch}`);
            
            // Unsubscribe from previous listener if exists
            if (unsubscribeInventory) {
                unsubscribeInventory();
            }
            
            // Query Firestore for items in this branch
            const q = db.collection('inventory').where('branchId', '==', currentBranch);
            
            unsubscribeInventory = q.onSnapshot((snapshot) => {
                console.log(`üì¶ Inventory update received:`, snapshot.size, "items");
                
                allItems = [];
                
                if (snapshot.empty) {
                    const inventoryBody = document.getElementById('inventoryBody');
                    inventoryBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px;">
                                <div style="color: #666; font-size: 12px;">
                                    üì≠ No items in inventory
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Process all items
                snapshot.forEach((doc) => {
                    const item = doc.data();
                    item.id = doc.id;
                    
                    // Get sale price for calculations
                    item.price = parseFloat(item.salePrice || item.price) || 0;
                    item.stock = parseInt(item.stock) || 0;
                    
                    allItems.push(item);
                });
                
                // Load inventory for display
                loadInventoryForSale();
                
            }, (error) => {
                console.error("‚ùå Inventory listener error:", error);
                const inventoryBody = document.getElementById('inventoryBody');
                inventoryBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #c53030;">
                            ‚ùå Error loading inventory
                        </td>
                    </tr>
                `;
            });
        }

        // Load inventory for sale display
        function loadInventoryForSale() {
            const inventoryBody = document.getElementById('inventoryBody');
            inventoryBody.innerHTML = '';
            
            allItems.forEach(item => {
                const row = inventoryBody.insertRow();
                
                // Determine if item can be added to cart
                const canAdd = item.stock > 0;
                
                row.innerHTML = `
                    <td><span class="code-badge">${escapeHtml(item.code || '')}</span></td>
                    <td><strong>${escapeHtml(item.name || '')}</strong></td>
                    <td>${getCategoryName(item.category)}</td>
                    <td>${item.stock}</td>
                    <td><strong>${formatCurrency(item.price)}</strong></td>
                    <td>${escapeHtml(item.location || '')}</td>
                    <td>
                        <div style="display: flex; gap: 0.4rem; align-items: center;">
                            <input type="number" class="qty-input" id="qty-${item.id}" 
                                   value="1" min="1" max="${item.stock}" ${!canAdd ? 'disabled' : ''}>
                            <button class="add-btn" data-id="${item.id}" ${!canAdd ? 'disabled' : ''}>
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </td>
                `;
            });
            
            // Add event listeners to add buttons
            inventoryBody.querySelectorAll('button[data-id]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    const qtyInput = document.getElementById(`qty-${itemId}`);
                    const quantity = parseInt(qtyInput.value) || 1;
                    
                    addToCart(itemId, quantity);
                    
                    // Reset quantity input to 1
                    qtyInput.value = 1;
                });
            });
        }

        // Get category display name
        function getCategoryName(categoryCode) {
            const categories = {
                'phone accessories': 'Phone Accessories',
                'stationary': 'Stationary',
                'other suppliers': 'Other Suppliers',
                'paper': 'Paper',
                'ink': 'Ink & Toner',
                'frames': 'Frames',
                'printing': 'Printing',
                'art': 'Art Supplies',
                'other': 'Other'
            };
            return categories[categoryCode] || categoryCode || 'Uncategorized';
        }

        // Search items
        function searchItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                loadInventoryForSale();
                return;
            }
            
            const filteredItems = allItems.filter(item => {
                return (
                    (item.name || '').toLowerCase().includes(searchTerm) ||
                    (item.code || '').toLowerCase().includes(searchTerm) ||
                    (item.location || '').toLowerCase().includes(searchTerm) ||
                    getCategoryName(item.category).toLowerCase().includes(searchTerm)
                );
            });
            
            const inventoryBody = document.getElementById('inventoryBody');
            inventoryBody.innerHTML = '';
            
            if (filteredItems.length === 0) {
                inventoryBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px;">
                            No items found for "${searchTerm}"
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Display filtered items
            filteredItems.forEach(item => {
                const row = inventoryBody.insertRow();
                const canAdd = item.stock > 0;
                
                row.innerHTML = `
                    <td><span class="code-badge">${escapeHtml(item.code || '')}</span></td>
                    <td><strong>${escapeHtml(item.name || '')}</strong></td>
                    <td>${getCategoryName(item.category)}</td>
                    <td>${item.stock}</td>
                    <td><strong>${formatCurrency(item.price)}</strong></td>
                    <td>${escapeHtml(item.location || '')}</td>
                    <td>
                        <div style="display: flex; gap: 0.4rem; align-items: center;">
                            <input type="number" class="qty-input" id="qty-${item.id}" 
                                   value="1" min="1" max="${item.stock}" ${!canAdd ? 'disabled' : ''}>
                            <button class="add-btn" data-id="${item.id}" ${!canAdd ? 'disabled' : ''}>
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </td>
                `;
            });
            
            // Re-add event listeners
            inventoryBody.querySelectorAll('button[data-id]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    const qtyInput = document.getElementById(`qty-${itemId}`);
                    const quantity = parseInt(qtyInput.value) || 1;
                    
                    addToCart(itemId, quantity);
                    
                    // Reset quantity input to 1
                    qtyInput.value = 1;
                });
            });
        }

        // Refresh items
        function refreshItems() {
            document.getElementById('searchInput').value = '';
            loadInventoryForSale();
        }

        // Add to cart
        function addToCart(itemId, quantity) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) {
                showMessage('Item not found', 'error');
                return;
            }
            
            if (quantity <= 0) {
                showMessage('Quantity must be at least 1', 'error');
                return;
            }
            
            if (quantity > item.stock) {
                showMessage(`Only ${item.stock} items available`, 'error');
                return;
            }
            
            // Check if item already in cart
            const existingItemIndex = cart.findIndex(cartItem => cartItem.id === itemId);
            
            if (existingItemIndex > -1) {
                // Update existing item
                const newQuantity = cart[existingItemIndex].quantity + quantity;
                if (newQuantity > item.stock) {
                    showMessage(`Cannot add ${quantity} more. Total would exceed available stock.`, 'error');
                    return;
                }
                cart[existingItemIndex].quantity = newQuantity;
                cart[existingItemIndex].subtotal = newQuantity * item.price;
            } else {
                // Add new item to cart
                cart.push({
                    id: itemId,
                    code: item.code,
                    name: item.name,
                    price: item.price,
                    orderPrice: item.orderPrice || 0,
                    quantity: quantity,
                    subtotal: quantity * item.price
                });
            }
            
            renderCart();
            showMessage(`Added ${quantity} ${item.name} to cart`, 'success');
        }

        // Render cart
        function renderCart() {
            const cartList = document.getElementById('cartList');
            const cartIndicator = document.getElementById('cartIndicator');
            const subtotalDisplay = document.getElementById('subtotalDisplay');
            const totalDisplay = document.getElementById('totalDisplay');
            const discountAmountDisplay = document.getElementById('discountAmountDisplay');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (cart.length === 0) {
                cartList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #a0aec0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <div>Your cart is empty</div>
                        <div style="font-size: 0.75rem; margin-top: 0.5rem;">Add items from the inventory</div>
                    </div>
                `;
                cartIndicator.textContent = '0 items';
                subtotalDisplay.textContent = formatCurrency(0);
                totalDisplay.textContent = formatCurrency(0);
                discountAmountDisplay.textContent = '-';
                checkoutBtn.disabled = true;
                return;
            }
            
            // Calculate subtotal
            const subtotal = cart.reduce((sum, item) => sum + item.subtotal, 0);
            
            // Calculate discount
            const discountType = document.getElementById('discountType').value;
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            let discountAmount = 0;
            
            if (discountType === 'percent') {
                discountAmount = (subtotal * discountValue) / 100;
            } else if (discountType === 'fixed') {
                discountAmount = Math.min(discountValue, subtotal);
            }
            
            // Calculate total
            const total = Math.max(0, subtotal - discountAmount);
            
            // Update displays
            subtotalDisplay.textContent = formatCurrency(subtotal);
            totalDisplay.textContent = formatCurrency(total);
            discountAmountDisplay.textContent = discountAmount > 0 ? `-${formatCurrency(discountAmount)}` : '-';
            
            // Update cart indicator
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartIndicator.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
            
            // Render cart items
            cartList.innerHTML = '';
            cart.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <div class="cart-item-info">
                        <div><strong>${escapeHtml(item.name)}</strong></div>
                        <div style="font-size: 0.75rem; color: #718096;">
                            ${escapeHtml(item.code)} ‚Ä¢ ${formatCurrency(item.price)} each
                        </div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="cart-item-btn" data-action="decrease" data-index="${index}">-</button>
                        <span style="min-width: 30px; text-align: center; font-weight: 600;">${item.quantity}</span>
                        <button class="cart-item-btn" data-action="increase" data-index="${index}">+</button>
                        <button class="cart-item-btn remove-btn" data-action="remove" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                cartList.appendChild(itemDiv);
            });
            
            // Add event listeners to cart controls
            cartList.querySelectorAll('.cart-item-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    const index = parseInt(this.getAttribute('data-index'));
                    updateCartItem(index, action);
                });
            });
            
            checkoutBtn.disabled = false;
        }

        // Update cart item
        function updateCartItem(index, action) {
            if (index < 0 || index >= cart.length) return;
            
            const item = cart[index];
            const inventoryItem = allItems.find(i => i.id === item.id);
            
            switch(action) {
                case 'increase':
                    if (item.quantity + 1 > inventoryItem.stock) {
                        showMessage(`Only ${inventoryItem.stock} items available`, 'error');
                        return;
                    }
                    item.quantity++;
                    item.subtotal = item.quantity * item.price;
                    break;
                    
                case 'decrease':
                    if (item.quantity > 1) {
                        item.quantity--;
                        item.subtotal = item.quantity * item.price;
                    } else {
                        cart.splice(index, 1);
                    }
                    break;
                    
                case 'remove':
                    cart.splice(index, 1);
                    break;
            }
            
            renderCart();
        }

        // Clear cart
        function clearCart() {
            if (cart.length === 0) return;
            
            if (confirm('Clear all items from cart?')) {
                cart = [];
                renderCart();
                showMessage('Cart cleared', 'info');
            }
        }

        // Checkout
        async function checkout() {
            if (cart.length === 0) {
                showMessage('Cart is empty', 'error');
                return;
            }
            
            if (!confirm('Process sale?')) {
                return;
            }
            
            try {
                // Calculate totals
                const subtotal = cart.reduce((sum, item) => sum + item.subtotal, 0);
                const discountType = document.getElementById('discountType').value;
                const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
                let discountAmount = 0;
                
                if (discountType === 'percent') {
                    discountAmount = (subtotal * discountValue) / 100;
                } else if (discountType === 'fixed') {
                    discountAmount = Math.min(discountValue, subtotal);
                }
                
                const total = Math.max(0, subtotal - discountAmount);
                const customerName = document.getElementById('customerInput').value.trim() || 'Walk-in';
                
                // Create sale record
                const sale = {
                    customerName: customerName,
                    items: cart.map(item => ({
                        itemId: item.id,
                        code: item.code,
                        name: item.name,
                        price: item.price,
                        cost: item.orderPrice,
                        quantity: item.quantity,
                        subtotal: item.subtotal,
                        costTotal: item.quantity * item.orderPrice
                    })),
                    subtotal: subtotal,
                    discount: {
                        type: discountType,
                        value: discountValue,
                        amount: discountAmount
                    },
                    total: total,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    processedBy: currentUserData.username,
                    branchId: currentBranch,
                    status: 'completed'
                };
                
                // Save to Firestore
                const saleRef = await db.collection('sales').add(sale);
                
                // Update inventory for each item
                for (const item of cart) {
                    const itemRef = db.collection('inventory').doc(item.id);
                    await itemRef.update({
                        stock: FieldValue.increment(-item.quantity),
                        sold: FieldValue.increment(item.quantity)
                    });
                }
                
                // Show success message
                showMessage(`‚úÖ Sale processed successfully! Total: ${formatCurrency(total)}`, 'success');
                
                // Clear cart and reset form
                cart = [];
                document.getElementById('customerInput').value = '';
                document.getElementById('discountType').value = 'none';
                document.getElementById('discountValue').value = '';
                document.getElementById('discountValue').disabled = true;
                
                renderCart();
                
                // Redirect back to sales dashboard after 2 seconds
                setTimeout(() => {
                    window.location.href = 'sales.html';
                }, 2000);
                
            } catch (error) {
                console.error('Checkout error:', error);
                showMessage('Error processing sale: ' + error.message, 'error');
            }
        }

        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';

            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Logout function
        function logout() {
            // Unsubscribe from Firestore listeners
            if (unsubscribeInventory) {
                unsubscribeInventory();
            }

            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
