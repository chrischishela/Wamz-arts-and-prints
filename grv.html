<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wamz Arts & Prints - GRV Upload & Process</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.5;
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
        }

        /* DASHBOARD LAYOUT */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
            position: relative;
        }

        /* SIDEBAR - COLLAPSIBLE ON ALL SCREENS */
        .sidebar {
            background: #2d3748;
            color: white;
            width: 250px;
            min-width: 250px;
            padding: 1.5rem 0.8rem;
            border-right: 1px solid #4a5568;
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: 100vh;
            z-index: 100;
            transition: width 0.3s ease, min-width 0.3s ease;
        }

        .sidebar.collapsed {
            width: 70px;
            min-width: 70px;
        }

        .sidebar-title {
            font-size: 0.9rem;
            color: #cbd5e0;
            margin-bottom: 1.2rem;
            padding: 0 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            overflow: hidden;
            white-space: nowrap;
        }

        .sidebar.collapsed .sidebar-title {
            opacity: 0;
            height: 0;
            margin: 0;
            padding: 0;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.8rem;
            background: none;
            border: none;
            text-align: left;
            color: #cbd5e0;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 0.8rem 0.5rem;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-item.active {
            background: #4299e1;
            color: white;
        }

        .nav-item span {
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-item span {
            opacity: 0;
            width: 0;
            display: none;
        }

        .nav-item i {
            min-width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        /* SIDEBAR TOGGLE BUTTON */
        .sidebar-toggle {
            position: absolute;
            top: 1rem;
            right: -12px;
            background: #4299e1;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            z-index: 101;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .sidebar-toggle:hover {
            background: #3182ce;
            transform: scale(1.1);
        }

        .sidebar.collapsed .sidebar-toggle {
            right: -12px;
        }

        /* MAIN CONTENT AREA */
        .main-content {
            flex: 1;
            background: #f5f7fa;
            padding: 1rem;
            overflow-y: auto;
            min-height: 100vh;
            width: 100%;
            transition: margin-left 0.3s ease;
        }

        /* HEADER */
        .header {
            background: #1a365d;
            color: white;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .user-name {
            font-weight: 500;
            color: #e2e8f0;
            font-size: 0.85rem;
        }

        .branch-badge {
            background: #4299e1;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .admin-badge {
            background: #e53e3e;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .logout-btn {
            background: #2d3748;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .logout-btn:hover {
            background: #4a5568;
        }

        /* Message */
        .message {
            padding: 0.8rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
            border: 1px solid transparent;
            font-size: 0.8rem;
        }

        .message.success {
            background: #f0fff4;
            color: #276749;
            border-color: #c6f6d5;
        }

        .message.error {
            background: #fff5f5;
            color: #c53030;
            border-color: #fed7d7;
        }

        .message.info {
            background: #ebf8ff;
            color: #2c5282;
            border-color: #bee3f8;
        }

        /* GRV Container */
        .grv-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .page-header h2 {
            font-size: 1rem;
            color: #2d3748;
            font-weight: 600;
        }

        .page-subtitle {
            color: #718096;
            font-size: 0.75rem;
            margin-top: 0.2rem;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            background: #4299e1;
            color: #fff;
            transition: all 0.2s;
            font-size: 0.75rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn:hover {
            background: #3182ce;
        }

        .btn.ghost {
            background: transparent;
            color: #4299e1;
            border: 1px solid #4299e1;
        }

        .btn.ghost:hover {
            background: rgba(66, 153, 225, 0.1);
        }

        .btn.secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn.secondary:hover {
            background: #cbd5e0;
        }

        .btn.green {
            background: #38a169;
            color: white;
        }

        .btn.green:hover {
            background: #2f855a;
        }

        /* Main Grid Layout - MODIFIED: Default to single column showing only history */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            transition: grid-template-columns 0.3s ease;
        }

        .main-grid.form-visible {
            grid-template-columns: 1fr 300px;
        }

        .main-grid.history-hidden {
            grid-template-columns: 1fr;
        }

        /* Cards */
        .card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            width: 100%;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .card-title {
            font-size: 0.9rem;
            color: #2d3748;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 0.7rem;
            color: #718096;
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.8rem;
            align-items: end;
        }

        .price-columns {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.8rem;
        }

        label {
            display: block;
            font-size: 0.75rem;
            color: #718096;
            margin-bottom: 0.3rem;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            font-size: 0.8rem;
            background: white;
            transition: all 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        input.readonly {
            background: #f8fafc;
            color: #718096;
            cursor: not-allowed;
        }

        /* Table */
        .table-container {
            max-height: 35vh;
            overflow: auto;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }

        th {
            background: #f8fafc;
            padding: 0.6rem;
            text-align: left;
            font-size: 0.7rem;
            color: #718096;
            font-weight: 600;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }

        td {
            padding: 0.6rem;
            border-bottom: 1px solid #f7fafc;
            font-size: 0.8rem;
            color: #4a5568;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: #f8fafc;
        }

        /* Row Controls */
        .row-controls {
            display: flex;
            gap: 0.3rem;
            flex-wrap: wrap;
        }

        .row-controls .btn {
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
        }

        /* History Items */
        .history-container {
            max-height: 40vh;
            overflow: auto;
        }

        .history-item {
            padding: 0.8rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-bottom: 0.5rem;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            border-color: #4299e1;
            background: #ebf8ff;
        }

        .history-item.selected {
            border-color: #4299e1;
            background: #ebf8ff;
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.2);
        }

        .history-info h4 {
            font-size: 0.8rem;
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 0.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .history-info p {
            font-size: 0.7rem;
            color: #718096;
        }

        .grv-total {
            background: #4299e1;
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.8rem;
            flex-wrap: wrap;
        }

        .item-count {
            font-size: 0.75rem;
            color: #718096;
            font-weight: 500;
        }

        /* Add New Button */
        .add-new-btn {
            background: #38a169;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .add-new-btn:hover {
            background: #2f855a;
        }

        /* GRV Details Modal */
        .grv-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 0.8rem;
        }

        .grv-details-content {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .grv-details-header {
            background: #1a365d;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .grv-details-header h3 {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .close-modal {
            background: transparent;
            color: white;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .grv-details-body {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }

        .grv-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1rem;
            padding: 0.8rem;
            background: #f8fafc;
            border-radius: 6px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.7rem;
            color: #718096;
            margin-bottom: 0.2rem;
        }

        .summary-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2d3748;
        }

        .summary-value.total {
            color: #e53e3e;
            font-size: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar.collapsed {
                width: 250px;
                min-width: 250px;
                transform: translateX(-100%);
            }

            .sidebar.collapsed.open {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: none;
            }

            .mobile-menu-toggle {
                display: flex;
                background: #4299e1;
                color: white;
                border: none;
                width: 32px;
                height: 32px;
                border-radius: 6px;
                cursor: pointer;
                align-items: center;
                justify-content: center;
                font-size: 0.9rem;
            }

            .header-left {
                gap: 0.5rem;
            }

            .main-grid.form-visible {
                grid-template-columns: 1fr;
            }

            .page-header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.8rem;
            }

            .controls {
                width: 100%;
                justify-content: space-between;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .price-columns {
                grid-template-columns: 1fr;
            }

            .table-container {
                max-height: 40vh;
            }
        }

        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .header-left {
                flex-direction: column;
                align-items: flex-start;
            }

            .user-info {
                width: 100%;
                justify-content: space-between;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                width: 100%;
            }

            .form-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .add-new-btn {
                width: 100%;
                justify-content: center;
            }

            .grv-summary {
                grid-template-columns: 1fr;
            }

            .table-container {
                max-height: 35vh;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-toggle {
                display: none;
            }
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            backdrop-filter: blur(3px);
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* SCROLLBAR STYLING */
        .table-container::-webkit-scrollbar,
        .history-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .table-container::-webkit-scrollbar-track,
        .history-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb,
        .history-container::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover,
        .history-container::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="sidebar-title">Navigation</div>
            <div class="nav-menu">
                <a href="admin-dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="branches.html" class="nav-item">
                    <i class="fas fa-building"></i>
                    <span>Branches</span>
                </a>
                <a href="grv.html" class="nav-item active">
                    <i class="fas fa-upload"></i>
                    <span>Add Stock</span>
                </a>
                <a href="admin-warehouse.html" class="nav-item">
                    <i class="fas fa-warehouse"></i>
                    <span>Warehouse</span>
                </a>
                <a href="admin-sales.html" class="nav-item">
                    <i class="fas fa-shopping-cart"></i>
                    <span>All Sales Data</span>
                </a>
                <a href="admin-reports.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="admin-cashflow.html" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Cash Flow</span>
                </a>
                <button class="nav-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <button class="mobile-menu-toggle" id="mobileMenuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Wamz Arts & Prints - GRV Upload & Process</h1>
                </div>
                <div class="user-info">
                    <span class="user-name">Welcome, <strong id="currentUser">User</strong></span>
                    <span class="branch-badge" id="branchBadge">Admin</span>
                    <span class="admin-badge" id="adminBadge">ADMIN</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Message Display -->
            <div class="message" id="message"></div>

            <!-- GRV Container -->
            <div class="grv-container">
                <!-- Page Header -->
                <div class="page-header">
                    <div>
                        <h2>GRV Upload & Process</h2>
                        <div class="page-subtitle">Batch restock across branches</div>
                    </div>
                    <div class="controls">
                        <button class="add-new-btn" id="addNewBtn">
                            <i class="fas fa-plus"></i>
                            <span>Add New Item</span>
                        </button>
                        <button class="btn secondary" id="toggleFormBtn" title="Show / hide Add Form" style="display: none;">Show Form</button>
                        <button class="btn secondary" id="toggleHistoryBtn" title="Show / hide GRV History">Hide History</button>
                    </div>
                </div>

                <div class="main-grid" id="mainGrid">
                    <!-- Left: Form and Items List - INITIALLY HIDDEN -->
                    <div id="formSection" style="display: none;">
                        <!-- Add Form (Collapsible) -->
                        <div class="card" id="addForm">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Add New Item</div>
                                    <div class="card-subtitle">Fill in the details below to add items to GRV</div>
                                </div>
                                <div>
                                    <button id="hideFormBtn" class="btn ghost">
                                        <i class="fas fa-times"></i> Hide
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-grid">
                                <div>
                                    <label for="branchSelect">Branch</label>
                                    <select id="branchSelect">
                                        <option value="branch1">Branch 1 (Main)</option>
                                        <option value="branch2">Branch 2</option>
                                        <option value="branch3">Branch 3</option>
                                    </select>
                                </div>

                                <div style="position: relative;">
                                    <label for="itemCode">Item Code</label>
                                    <input id="itemCode" placeholder="Start typing or pick existing..." list="codesList" autocomplete="off" />
                                    <datalist id="codesList"></datalist>
                                </div>

                                <div>
                                    <label for="itemName">Item Name</label>
                                    <input id="itemName" placeholder="A4 Paper" />
                                </div>

                                <div>
                                    <label for="itemCategory">Category</label>
                                    <select id="itemCategory">
                                        <option value="">Select Category</option>
                                        <option value="phone accessories">Phone Accessories</option>
                                        <option value="stationary">Stationary</option>
                                        <option value="other suppliers">Other Suppliers</option>
                                    </select>
                                </div>

                                <div>
                                    <label for="itemQty">Quantity</label>
                                    <input id="itemQty" type="number" min="1" value="10" />
                                </div>

                                <!-- ADDED: Order Price and Sale Price -->
                                <div class="price-columns">
                                    <div>
                                        <label for="itemOrderPrice">Order Price (ZMW)</label>
                                        <input id="itemOrderPrice" type="number" step="0.01" min="0" placeholder="Cost from supplier" />
                                    </div>

                                    <div>
                                        <label for="itemSalePrice">Sale Price (ZMW)</label>
                                        <input id="itemSalePrice" type="number" step="0.01" min="0" placeholder="Selling price" />
                                    </div>
                                </div>

                                <div style="grid-column: 1 / -1;">
                                    <label for="itemLocation">Location</label>
                                    <input id="itemLocation" placeholder="Shelf A1" />
                                    <button class="btn ghost" id="useNewBtn" style="margin-top: 0.5rem; width: auto;">Force New Item</button>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button id="addRowBtn" class="btn">Add to GRV List</button>
                                <button id="clearFormBtn" class="btn ghost">Clear Form</button>
                                <div style="flex: 1"></div>
                                <div class="item-count" id="listCount">0 items in list</div>
                            </div>
                        </div>

                        <!-- Items List -->
                        <div class="card" style="margin-top: 1rem;" id="itemsListCard">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">GRV Items List</div>
                                    <div class="card-subtitle">Items ready for processing</div>
                                </div>
                            </div>

                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width: 40px">#</th>
                                            <th>Branch</th>
                                            <th>Code</th>
                                            <th>Name</th>
                                            <th style="width: 60px">Qty</th>
                                            <!-- ADDED: Order Price and Sale Price columns -->
                                            <th style="width: 80px">Order Price</th>
                                            <th style="width: 80px">Sale Price</th>
                                            <th>Total</th>
                                            <th style="width: 120px">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rowsBody">
                                        <tr>
                                            <td colspan="9" style="text-align: center; padding: 1.5rem; color: #a0aec0; font-size: 0.8rem;">
                                                No items added yet. Start by adding items above.
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="action-buttons">
                                <button id="exportListCsv" class="btn secondary">Export CSV</button>
                                <button id="processBtn" class="btn green">Process GRV</button>
                            </div>
                        </div>
                    </div>

                    <!-- Right: GRV History - INITIALLY VISIBLE -->
                    <div class="card" id="historySection">
                        <div class="card-header">
                            <div>
                                <div class="card-title">GRV History</div>
                                <div class="card-subtitle">Click on a GRV to view details</div>
                            </div>
                        </div>

                        <div class="history-container" id="historyContainer">
                            <div style="text-align: center; padding: 1.5rem; color: #a0aec0; font-size: 0.8rem;">
                                Loading GRV history...
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button id="downloadAllCsv" class="btn secondary">Export All GRVs (CSV)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GRV Details Modal -->
    <div class="grv-details-modal" id="grvDetailsModal">
        <div class="grv-details-content">
            <div class="grv-details-header">
                <h3 id="grvDetailsTitle">GRV Details</h3>
                <button class="close-modal" id="closeModalBtn">&times;</button>
            </div>
            <div class="grv-details-body">
                <div class="grv-summary" id="grvSummary">
                    <!-- Summary will be loaded here -->
                </div>
                <div class="table-container">
                    <table id="grvItemsTable">
                        <thead>
                            <tr>
                                <th style="width: 40px">#</th>
                                <th>Branch</th>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th style="width: 50px">Qty</th>
                                <!-- ADDED: Order Price and Sale Price in details modal -->
                                <th style="width: 80px">Order Price</th>
                                <th style="width: 80px">Sale Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="grvItemsBody">
                            <!-- GRV items will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

   <script>
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyDTslfW2YQOw1XqiTn4RgTNKusi4w6NcHI",
        authDomain: "wamz-arts-and-prints.firebaseapp.com",
        projectId: "wamz-arts-and-prints",
        storageBucket: "wamz-arts-and-prints.firebasestorage.app",
        messagingSenderId: "495100135771",
        appId: "1:495100135771:web:d63ab48db021b4b02c327e",
        measurementId: "G-1HL55EC1D1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const FieldValue = firebase.firestore.FieldValue;

    // State
    let currentUser = null;
    let grvRows = [];
    let grvHistoryUnsub = null;
    let inventoryUnsub = null;
    let selectedGRV = null;
    const codeMap = {};

    // Initialize sidebar
    function initializeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const overlay = document.getElementById('sidebarOverlay');
        
        // Load saved sidebar state
        const savedState = localStorage.getItem('sidebarCollapsed');
        if (savedState === 'true') {
            sidebar.classList.add('collapsed');
        }
        
        // Desktop sidebar toggle
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        });
        
        // Mobile menu toggle
        mobileMenuToggle.addEventListener('click', () => {
            sidebar.classList.add('open');
            overlay.classList.add('active');
        });
        
        // Close sidebar on overlay click (mobile)
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        });
        
        // Close sidebar when clicking on links (mobile)
        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('active');
                }
            });
        });
    }

    // Show message
    function showMessage(text, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = text;
        messageDiv.className = 'message ' + type;
        messageDiv.style.display = 'block';
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }

    // Format ZMW currency
    function formatZMW(n) { 
        return 'ZMW ' + Number(n || 0).toLocaleString('en-ZM', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }); 
    }

    // Logout function
    function logout() {
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
    }

    // Access check
    (function initAccess() {
        const cur = localStorage.getItem('currentUser');
        if (!cur) { 
            window.location.href = 'index.html'; 
            return; 
        }
        
        const u = JSON.parse(cur);
        if (u.username !== 'Wamz' && u.role !== 'admin') { 
            window.location.href = 'user-dashboard.html'; 
            return; 
        }
        
        currentUser = u;
        document.getElementById('currentUser').textContent = u.username;
        initializeSidebar();
    })();

    // Helper functions
    function $id(id) { return document.getElementById(id); }
    
    function downloadTextFile(text, filename) { 
        const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' }); 
        const url = URL.createObjectURL(blob); 
        const a = document.createElement('a'); 
        a.href = url; 
        a.download = filename; 
        document.body.appendChild(a); 
        a.click(); 
        a.remove(); 
        setTimeout(() => URL.revokeObjectURL(url), 5000); 
    }

    // Toggle form and history sections
    const addFormEl = $id('addForm');
    const itemsListCard = $id('itemsListCard');
    const formSection = $id('formSection');
    const historySectionEl = $id('historySection');
    const toggleFormBtn = $id('toggleFormBtn');
    const toggleHistoryBtn = $id('toggleHistoryBtn');
    const mainGrid = $id('mainGrid');
    const addNewBtn = $id('addNewBtn');
    const hideFormBtn = $id('hideFormBtn');

    function toggleSection(type) {
        if (type === 'form') {
            const isHidden = formSection.style.display === 'none';
            if (isHidden) {
                formSection.style.display = 'block';
                toggleFormBtn.textContent = 'Hide Form';
                toggleFormBtn.style.display = 'block';
                mainGrid.classList.add('form-visible');
            } else {
                formSection.style.display = 'none';
                toggleFormBtn.textContent = 'Show Form';
                toggleFormBtn.style.display = 'block';
                mainGrid.classList.remove('form-visible');
            }
        } else if (type === 'history') {
            const isHidden = historySectionEl.style.display === 'none';
            if (isHidden) {
                historySectionEl.style.display = 'block';
                toggleHistoryBtn.textContent = 'Hide History';
                mainGrid.classList.remove('history-hidden');
            } else {
                historySectionEl.style.display = 'none';
                toggleHistoryBtn.textContent = 'Show History';
                mainGrid.classList.add('history-hidden');
            }
        }
    }

    toggleFormBtn.addEventListener('click', () => {
        toggleSection('form');
    });

    toggleHistoryBtn.addEventListener('click', () => {
        toggleSection('history');
    });

    addNewBtn.addEventListener('click', () => {
        if (formSection.style.display === 'none') {
            formSection.style.display = 'block';
            toggleFormBtn.textContent = 'Hide Form';
            toggleFormBtn.style.display = 'block';
            mainGrid.classList.add('form-visible');
        }
        $id('itemCode').focus();
    });

    hideFormBtn.addEventListener('click', () => {
        formSection.style.display = 'none';
        toggleFormBtn.textContent = 'Show Form';
        toggleFormBtn.style.display = 'block';
        mainGrid.classList.remove('form-visible');
    });

    // Render rows in GRV list
    function renderRows() {
        const tbody = $id('rowsBody');
        tbody.innerHTML = '';
        
        if (!grvRows.length) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 1.5rem; color: #a0aec0; font-size: 0.8rem;">
                        No items added yet. Start by adding items above.
                    </td>
                </tr>
            `;
            $id('listCount').textContent = '0 items in list';
            return;
        }
        
        let totalValue = 0;
        let totalOrderValue = 0;
        let totalSaleValue = 0;
        
        grvRows.forEach((r, i) => {
            const orderTotal = (r.qty || 0) * (r.orderPrice || 0);
            const saleTotal = (r.qty || 0) * (r.salePrice || 0);
            totalOrderValue += orderTotal;
            totalSaleValue += saleTotal;
            totalValue += orderTotal; // Using order price for total GRV value
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${i + 1}</td>
                <td>${r.branch === 'branch1' ? 'Branch 1' : r.branch === 'branch2' ? 'Branch 2' : 'Branch 3'}</td>
                <td><strong>${r.code}</strong></td>
                <td>${r.name}</td>
                <td>${r.qty}</td>
                <td>${formatZMW(r.orderPrice || 0)}</td>
                <td>${formatZMW(r.salePrice || 0)}</td>
                <td style="font-weight: 600; color: #2d3748;">${formatZMW(orderTotal)}</td>
                <td>
                    <div class="row-controls">
                        <button class="btn ghost" onclick="editRow(${i})" style="padding: 0.2rem 0.4rem; font-size: 0.7rem;">Edit</button>
                        <button class="btn ghost" onclick="removeRow(${i})" style="padding: 0.2rem 0.4rem; font-size: 0.7rem;">Remove</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add total row
        const totalRow = document.createElement('tr');
        totalRow.style.backgroundColor = '#f8fafc';
        totalRow.style.fontWeight = '600';
        totalRow.innerHTML = `
            <td colspan="5" style="text-align: right; color: #718096;">Totals:</td>
            <td style="color: #4299e1;">${formatZMW(totalOrderValue)}</td>
            <td style="color: #38a169;">${formatZMW(totalSaleValue)}</td>
            <td style="color: #e53e3e; font-size: 0.85rem;">${formatZMW(totalValue)}</td>
            <td></td>
        `;
        tbody.appendChild(totalRow);
        
        $id('listCount').textContent = `${grvRows.length} item${grvRows.length === 1 ? '' : 's'} in list â€¢ ${formatZMW(totalValue)}`;
    }

    // Remove row
    window.removeRow = function(idx) {
        grvRows.splice(idx, 1);
        renderRows();
    };

    // Edit row
    window.editRow = function(idx) {
        const r = grvRows[idx];
        if (!r) return;
        
        $id('branchSelect').value = r.branch;
        $id('itemCode').value = r.code;
        $id('itemName').value = r.name;
        $id('itemCategory').value = r.category;
        $id('itemQty').value = r.qty;
        $id('itemOrderPrice').value = Number(r.orderPrice || 0).toFixed(2);
        $id('itemSalePrice').value = Number(r.salePrice || 0).toFixed(2);
        $id('itemLocation').value = r.location || '';
        
        // Ensure form is visible
        if (formSection.style.display === 'none') {
            formSection.style.display = 'block';
            toggleFormBtn.textContent = 'Hide Form';
            toggleFormBtn.style.display = 'block';
            mainGrid.classList.add('form-visible');
        }
        
        // Remove row while editing
        grvRows.splice(idx, 1);
        renderRows();
    };

    // Clear form
    function clearForm() {
        $id('itemCode').value = '';
        $id('itemName').value = '';
        $id('itemCategory').value = '';
        $id('itemQty').value = '10';
        $id('itemOrderPrice').value = '';
        $id('itemSalePrice').value = '';
        $id('itemLocation').value = '';
    }

    // Code input handler - ONLY auto-fills name and category, NOT prices or location
    function onCodeInput() {
        const codeRaw = ($id('itemCode').value || '').trim();
        const code = codeRaw.toUpperCase();
        
        if (!code) { 
            return; 
        }
        
        const entry = codeMap[code];
        if (entry) {
            // Only auto-fill name and category
            $id('itemName').value = entry.name || code;
            $id('itemCategory').value = entry.category || '';
            
            // Do NOT auto-fill prices, quantity, or location
            // Leave orderPrice, salePrice, qty, and location empty/with defaults
            
            // Focus on quantity field for user to enter
            $id('itemQty').focus();
        } else {
            // For new items, still fill name with code if empty
            if (!$id('itemName').value) {
                $id('itemName').value = code;
            }
        }
    }

    // Add row to GRV list
    $id('addRowBtn').addEventListener('click', () => {
        const branch = $id('branchSelect').value;
        const rawCode = ($id('itemCode').value || '').trim();
        
        if (!rawCode) { 
            showMessage('Please enter an item code', 'error');
            return; 
        }
        
        const code = rawCode.toUpperCase();
        const qty = parseInt($id('itemQty').value || '0', 10) || 0;
        const orderPrice = parseFloat($id('itemOrderPrice').value || '0') || 0;
        const salePrice = parseFloat($id('itemSalePrice').value || '0') || 0;
        const name = ($id('itemName').value || '').trim() || code;
        const category = $id('itemCategory').value || 'other suppliers';
        const location = ($id('itemLocation').value || '').trim();
        
        if (!qty || qty <= 0) { 
            showMessage('Please enter a valid quantity (>0)', 'error');
            return; 
        }
        
        if (!orderPrice || orderPrice <= 0) { 
            showMessage('Please enter a valid order price (>0)', 'error');
            return; 
        }
        
        if (!salePrice || salePrice <= 0) { 
            showMessage('Please enter a valid sale price (>0)', 'error');
            return; 
        }
        
        // Avoid duplicate branch+code in working list
        const existingIndex = grvRows.findIndex(r => r.branch === branch && r.code === code);
        
        if (existingIndex !== -1) {
            // Merge quantities
            grvRows[existingIndex].qty += qty;
            // Update prices if they were changed
            grvRows[existingIndex].orderPrice = orderPrice;
            grvRows[existingIndex].salePrice = salePrice;
            showMessage(`Updated quantity for ${code} in ${branch}`, 'info');
        } else {
            const existingCode = codeMap[code];
            const row = {
                branch, 
                code, 
                name: existingCode ? (existingCode.name || name) : name,
                category: existingCode ? (existingCode.category || category) : category,
                qty, 
                orderPrice: orderPrice, // Always use user-entered price
                salePrice: salePrice, // Always use user-entered price
                location: location // Always use user-entered location
            };
            grvRows.push(row);
            showMessage(`Added ${name} to GRV list`, 'success');
        }
        
        renderRows();
        clearForm();
    });

    $id('clearFormBtn').addEventListener('click', clearForm);
    $id('useNewBtn').addEventListener('click', () => {
        $id('itemCode').value = $id('itemCode').value.trim();
        $id('itemName').focus();
    });

    // Export list as CSV
    $id('exportListCsv').addEventListener('click', () => {
        if (!grvRows.length) { 
            showMessage('No rows to export', 'error');
            return; 
        }
        
        const rows = [['Branch', 'Code', 'Name', 'Category', 'Quantity', 'Order Price', 'Sale Price', 'Location', 'Order Total', 'Sale Total']];
        grvRows.forEach(r => {
            const orderTotal = (r.qty || 0) * (r.orderPrice || 0);
            const saleTotal = (r.qty || 0) * (r.salePrice || 0);
            rows.push([
                r.branch, 
                r.code, 
                r.name, 
                r.category, 
                r.qty, 
                (r.orderPrice || 0).toFixed(2), 
                (r.salePrice || 0).toFixed(2),
                r.location || '',
                orderTotal.toFixed(2),
                saleTotal.toFixed(2)
            ]);
        });
        
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
        downloadTextFile(csv, `grv-export-${new Date().toISOString().slice(0, 19)}.csv`);
        showMessage('CSV exported successfully', 'success');
    });

    // Process GRV
    $id('processBtn').addEventListener('click', async () => {
        if (!grvRows.length) { 
            showMessage('No rows to process', 'error');
            return; 
        }
        
        if (!confirm(`Process ${grvRows.length} items and update inventory?`)) return;
        
        const processBtn = $id('processBtn');
        const originalText = processBtn.textContent;
        processBtn.disabled = true;
        processBtn.textContent = 'Processing...';
        
        try {
            const resolved = await Promise.all(grvRows.map(async r => {
                const q = await db.collection('inventory')
                    .where('branchId', '==', r.branch)
                    .where('code', '==', r.code)
                    .limit(1)
                    .get();
                
                if (!q.empty) {
                    const doc = q.docs[0];
                    const ref = db.collection('inventory').doc(doc.id);
                    const updateData = { 
                        stock: FieldValue.increment(r.qty),
                        orderPrice: r.orderPrice, // Always update with new price
                        salePrice: r.salePrice // Always update with new price
                    };
                    
                    if (r.location) updateData.location = r.location;
                    if (r.name) updateData.name = r.name;
                    if (r.category) updateData.category = r.category;
                    
                    return { ref, updateData, isNew: false, row: r };
                } else {
                    const id = `${r.branch}_${r.code}`;
                    const ref = db.collection('inventory').doc(id);
                    const setData = {
                        branchId: r.branch,
                        code: r.code,
                        name: r.name,
                        category: r.category,
                        stock: r.qty,
                        orderPrice: r.orderPrice || 0,
                        salePrice: r.salePrice || 0,
                        location: r.location || '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    return { ref, setData, isNew: true, row: r };
                }
            }));

            // Batch write
            const BATCH_SIZE = 400;
            let idx = 0;
            
            while (idx < resolved.length) {
                const batch = db.batch();
                const chunk = resolved.slice(idx, idx + BATCH_SIZE);
                
                chunk.forEach(op => {
                    if (op.isNew) {
                        batch.set(op.ref, op.setData, { merge: true });
                    } else {
                        batch.update(op.ref, op.updateData);
                    }
                });
                
                await batch.commit();
                idx += BATCH_SIZE;
            }

            // Create GRV history record
            const totalOrderValue = grvRows.reduce((s, r) => s + (Number(r.qty || 0) * Number(r.orderPrice || 0)), 0);
            const totalSaleValue = grvRows.reduce((s, r) => s + (Number(r.qty || 0) * Number(r.salePrice || 0)), 0);
            const historyDoc = {
                processedBy: currentUser.username,
                ts: firebase.firestore.FieldValue.serverTimestamp(),
                processedAt: Date.now(),
                rowsCount: grvRows.length,
                totalOrderValue,
                totalSaleValue,
                totalValue: totalOrderValue, // Keeping for backward compatibility
                items: grvRows
            };
            
            await db.collection('grvHistory').add(historyDoc);
            
            showMessage(`GRV processed successfully! ${grvRows.length} items updated. Order Total: ${formatZMW(totalOrderValue)} | Sale Total: ${formatZMW(totalSaleValue)}`, 'success');
            grvRows = [];
            renderRows();
            
        } catch (err) {
            console.error('Process GRV error', err);
            showMessage('Error processing GRV: ' + (err.message || err), 'error');
        } finally {
            processBtn.disabled = false;
            processBtn.textContent = originalText;
        }
    });

    // GRV History
    function renderHistoryList(docs) {
        const el = $id('historyContainer');
        el.innerHTML = '';
        
        if (!docs.length) {
            el.innerHTML = '<div style="text-align: center; padding: 1.5rem; color: #a0aec0; font-size: 0.8rem;">No GRV history yet.</div>';
            return;
        }
        
        docs.forEach((doc, index) => {
            const data = doc.data();
            const ts = data.processedAt ? new Date(data.processedAt) : (data.ts && data.ts.toDate ? data.ts.toDate() : new Date());
            const totalOrder = data.totalOrderValue || data.totalValue || 0;
            const totalSale = data.totalSaleValue || 0;
            const rowsCount = data.rowsCount || (data.items && data.items.length) || 0;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'history-item';
            wrapper.dataset.id = doc.id;
            wrapper.dataset.index = index;
            
            if (selectedGRV && selectedGRV.id === doc.id) {
                wrapper.classList.add('selected');
            }
            
            wrapper.onclick = () => showGRVDetails(doc.id, data, index);
            
            wrapper.innerHTML = `
                <div class="history-info">
                    <h4>
                        ${ts.toLocaleString()}
                        <span class="grv-total">${formatZMW(totalOrder)}</span>
                    </h4>
                    <p>${rowsCount} items â€¢ Processed by: ${data.processedBy || 'Unknown'}</p>
                    <p style="font-size: 0.7rem; color: #38a169; margin-top: 0.2rem;">
                        Sale Total: ${formatZMW(totalSale)}
                    </p>
                    <p style="font-size: 0.7rem; color: #a0aec0; margin-top: 0.2rem;">
                        ${ts.toLocaleDateString()} â€¢ ${ts.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </p>
                </div>
            `;
            
            el.appendChild(wrapper);
        });
    }

    // Show GRV Details
    async function showGRVDetails(docId, data, index) {
        selectedGRV = { id: docId, data: data };
        
        // Update UI selection
        document.querySelectorAll('.history-item').forEach(item => {
            item.classList.remove('selected');
        });
        document.querySelector(`.history-item[data-index="${index}"]`).classList.add('selected');
        
        // Show modal
        const modal = $id('grvDetailsModal');
        const title = $id('grvDetailsTitle');
        const summary = $id('grvSummary');
        const itemsBody = $id('grvItemsBody');
        
        const ts = data.processedAt ? new Date(data.processedAt) : (data.ts && data.ts.toDate ? data.ts.toDate() : new Date());
        const items = data.items || [];
        const totalOrderValue = data.totalOrderValue || data.totalValue || 0;
        const totalSaleValue = data.totalSaleValue || 0;
        
        // Update title
        title.textContent = `GRV Details - ${ts.toLocaleString()}`;
        
        // Calculate branch totals
        const branchOrderTotals = {};
        const branchSaleTotals = {};
        items.forEach(item => {
            const branch = item.branch === 'branch1' ? 'Branch 1' : item.branch === 'branch2' ? 'Branch 2' : 'Branch 3';
            const itemOrderTotal = (item.qty || 0) * (item.orderPrice || 0);
            const itemSaleTotal = (item.qty || 0) * (item.salePrice || 0);
            branchOrderTotals[branch] = (branchOrderTotals[branch] || 0) + itemOrderTotal;
            branchSaleTotals[branch] = (branchSaleTotals[branch] || 0) + itemSaleTotal;
        });
        
        // Update summary
        summary.innerHTML = `
            <div class="summary-item">
                <div class="summary-label">Total Items</div>
                <div class="summary-value">${items.length}</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Processed By</div>
                <div class="summary-value">${data.processedBy || 'Unknown'}</div>
            </div>
            ${Object.entries(branchOrderTotals).map(([branch, total]) => `
                <div class="summary-item">
                    <div class="summary-label">${branch} (Order)</div>
                    <div class="summary-value">${formatZMW(total)}</div>
                </div>
            `).join('')}
            ${Object.entries(branchSaleTotals).map(([branch, total]) => `
                <div class="summary-item">
                    <div class="summary-label">${branch} (Sale)</div>
                    <div class="summary-value" style="color: #38a169;">${formatZMW(total)}</div>
                </div>
            `).join('')}
            <div class="summary-item">
                <div class="summary-label">Total Order Value</div>
                <div class="summary-value total">${formatZMW(totalOrderValue)}</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Total Sale Value</div>
                <div class="summary-value" style="color: #38a169; font-size: 1.1rem;">${formatZMW(totalSaleValue)}</div>
            </div>
        `;
        
        // Update items table
        itemsBody.innerHTML = '';
        let runningOrderTotal = 0;
        let runningSaleTotal = 0;
        
        items.forEach((item, i) => {
            const itemOrderTotal = (item.qty || 0) * (item.orderPrice || 0);
            const itemSaleTotal = (item.qty || 0) * (item.salePrice || 0);
            runningOrderTotal += itemOrderTotal;
            runningSaleTotal += itemSaleTotal;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${i + 1}</td>
                <td>${item.branch === 'branch1' ? 'Branch 1' : item.branch === 'branch2' ? 'Branch 2' : 'Branch 3'}</td>
                <td><strong>${item.code}</strong></td>
                <td>${item.name}</td>
                <td>${item.category || '-'}</td>
                <td>${item.qty}</td>
                <td>${formatZMW(item.orderPrice || 0)}</td>
                <td>${formatZMW(item.salePrice || 0)}</td>
                <td style="font-weight: 600;">${formatZMW(itemOrderTotal)}</td>
            `;
            itemsBody.appendChild(tr);
        });
        
        // Add total rows
        const totalRow = document.createElement('tr');
        totalRow.style.backgroundColor = '#f8fafc';
        totalRow.style.fontWeight = '600';
        totalRow.innerHTML = `
            <td colspan="8" style="text-align: right; font-size: 0.8rem;">Order Total:</td>
            <td style="color: #e53e3e; font-size: 0.85rem;">${formatZMW(runningOrderTotal)}</td>
        `;
        itemsBody.appendChild(totalRow);
        
        const saleTotalRow = document.createElement('tr');
        saleTotalRow.style.backgroundColor = '#f0fff4';
        saleTotalRow.style.fontWeight = '600';
        saleTotalRow.innerHTML = `
            <td colspan="8" style="text-align: right; font-size: 0.8rem;">Sale Total:</td>
            <td style="color: #38a169; font-size: 0.85rem;">${formatZMW(runningSaleTotal)}</td>
        `;
        itemsBody.appendChild(saleTotalRow);
        
        // Show modal
        modal.style.display = 'flex';
    }

    // Close modal
    $id('closeModalBtn').addEventListener('click', () => {
        $id('grvDetailsModal').style.display = 'none';
    });

    // Close modal when clicking outside
    $id('grvDetailsModal').addEventListener('click', (e) => {
        if (e.target === $id('grvDetailsModal')) {
            $id('grvDetailsModal').style.display = 'none';
        }
    });

    function setupHistoryListener() {
        if (grvHistoryUnsub) grvHistoryUnsub();
        
        grvHistoryUnsub = db.collection('grvHistory')
            .orderBy('ts', 'desc')
            .limit(50)
            .onSnapshot(snap => {
                renderHistoryList(snap.docs);
            }, err => {
                $id('historyContainer').innerHTML = 
                    `<div style="text-align: center; padding: 1.5rem; color: #e53e3e; font-size: 0.8rem;">Error loading history: ${err.message}</div>`;
            });
    }

    // Inventory codes listener
    function setupInventoryCodesListener() {
        if (inventoryUnsub) inventoryUnsub();
        
        inventoryUnsub = db.collection('inventory').onSnapshot(snap => {
            const temp = {};
            
            snap.forEach(doc => {
                const d = doc.data();
                const code = (d.code || '').toString().toUpperCase();
                if (!code) return;
                
                const branchId = d.branchId || d.branch || 'branch1';
                const qty = parseInt(d.stock || d.qty || 0, 10) || 0;
                const orderPrice = parseFloat(d.orderPrice || 0) || 0;
                const salePrice = parseFloat(d.salePrice || 0) || 0;
                const location = d.location || '';
                const name = d.name || code;
                const category = d.category || '';
                
                if (!temp[code]) {
                    temp[code] = { 
                        code, 
                        name, 
                        category, 
                        orderPrice, 
                        salePrice,
                        location, 
                        branches: {} 
                    };
                }
                
                temp[code].branches[branchId] = (temp[code].branches[branchId] || 0) + qty;
                
                // We still store prices for reference, but won't auto-fill them
                if ((!temp[code].orderPrice || temp[code].orderPrice === 0) && orderPrice) {
                    temp[code].orderPrice = orderPrice;
                }
                
                if ((!temp[code].salePrice || temp[code].salePrice === 0) && salePrice) {
                    temp[code].salePrice = salePrice;
                }
                
                if (branchId === 'branch1') {
                    temp[code].orderPrice = orderPrice || temp[code].orderPrice;
                    temp[code].salePrice = salePrice || temp[code].salePrice;
                    temp[code].name = name || temp[code].name;
                    temp[code].category = category || temp[code].category;
                    temp[code].location = location || temp[code].location;
                } else {
                    if (!temp[code].location && location) {
                        temp[code].location = location;
                    }
                }
            });

            // Update codeMap
            Object.keys(codeMap).forEach(k => delete codeMap[k]);
            Object.keys(temp).forEach(k => codeMap[k] = temp[k]);
            populateDatalist();
            
        }, err => {
            console.error('Inventory codes listener error', err);
        });
    }

    function populateDatalist() {
        const dl = $id('codesList');
        dl.innerHTML = '';
        const codes = Object.keys(codeMap).sort();
        
        codes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            dl.appendChild(opt);
        });
    }

    // Export all GRV history
    $id('downloadAllCsv').addEventListener('click', async () => {
        const snap = await db.collection('grvHistory')
            .orderBy('ts', 'desc')
            .limit(500)
            .get();
        
        if (snap.empty) { 
            showMessage('No GRV history to export', 'info');
            return; 
        }
        
        const rows = [['Processed At', 'Processed By', 'Items Count', 'Order Total', 'Sale Total']];
        
        snap.forEach(doc => {
            const d = doc.data();
            const processedAt = d.processedAt ? 
                new Date(d.processedAt).toISOString() : 
                (d.ts && d.ts.toDate ? d.ts.toDate().toISOString() : '');
            
            rows.push([
                processedAt, 
                d.processedBy || '', 
                d.rowsCount || 0, 
                (d.totalOrderValue || d.totalValue || 0).toFixed(2),
                (d.totalSaleValue || 0).toFixed(2)
            ]);
        });
        
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
        downloadTextFile(csv, `grv-history-${new Date().toISOString().slice(0, 19)}.csv`);
        showMessage('All GRV history exported successfully', 'success');
    });

    // Initialize
    (function init() {
        $id('itemCode').addEventListener('input', onCodeInput);
        renderRows();
        setupHistoryListener();
        setupInventoryCodesListener();
    })();

    // Cleanup
    window.addEventListener('beforeunload', () => {
        if (grvHistoryUnsub) grvHistoryUnsub();
        if (inventoryUnsub) inventoryUnsub();
    });
</script>
</body>
</html>
