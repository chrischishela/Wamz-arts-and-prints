<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Warehouse - Wamz Arts & Prints</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.5;
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
        }

        /* DASHBOARD LAYOUT */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
            position: relative;
        }

        /* SIDEBAR - COLLAPSIBLE ON ALL SCREENS */
        .sidebar {
            background: #2d3748;
            color: white;
            width: 250px;
            min-width: 250px;
            padding: 1.5rem 0.8rem;
            border-right: 1px solid #4a5568;
            overflow-y: auto;
            position: sticky;
            top: 0;
            height: 100vh;
            z-index: 100;
            transition: width 0.3s ease, min-width 0.3s ease;
        }

        .sidebar.collapsed {
            width: 70px;
            min-width: 70px;
        }

        .sidebar-title {
            font-size: 0.9rem;
            color: #cbd5e0;
            margin-bottom: 1.2rem;
            padding: 0 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            overflow: hidden;
            white-space: nowrap;
        }

        .sidebar.collapsed .sidebar-title {
            opacity: 0;
            height: 0;
            margin: 0;
            padding: 0;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.8rem;
            background: none;
            border: none;
            text-align: left;
            color: #cbd5e0;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 0.8rem 0.5rem;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-item.active {
            background: #4299e1;
            color: white;
        }

        .nav-item span {
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-item span {
            opacity: 0;
            width: 0;
            display: none;
        }

        .nav-item i {
            min-width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        /* SIDEBAR TOGGLE BUTTON */
        .sidebar-toggle {
            position: absolute;
            top: 1rem;
            right: -12px;
            background: #4299e1;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            z-index: 101;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .sidebar-toggle:hover {
            background: #3182ce;
            transform: scale(1.1);
        }

        .sidebar.collapsed .sidebar-toggle {
            right: -12px;
        }

        /* MAIN CONTENT AREA */
        .main-content {
            flex: 1;
            background: #f5f7fa;
            padding: 1rem;
            overflow-y: auto;
            min-height: 100vh;
            width: 100%;
            transition: margin-left 0.3s ease;
        }

        /* HEADER */
        .header {
            background: #1a365d;
            color: white;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .user-name {
            font-weight: 500;
            color: #e2e8f0;
            font-size: 0.85rem;
        }

        .branch-badge {
            background: #4299e1;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .admin-badge {
            background: #e53e3e;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .logout-btn {
            background: #2d3748;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .logout-btn:hover {
            background: #4a5568;
        }

        .grv-btn {
            background: #38a169;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .grv-btn:hover {
            background: #2f855a;
        }

        /* Welcome Banner */
        .welcome-banner {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.2);
        }

        .welcome-banner h2 {
            font-size: 1rem;
            margin-bottom: 0.3rem;
            font-weight: 600;
        }

        .welcome-banner p {
            opacity: 0.9;
            font-size: 0.8rem;
        }

        /* Message Display */
        .message {
            padding: 0.6rem;
            border-radius: 6px;
            margin-bottom: 0.8rem;
            display: none;
            border: 1px solid transparent;
            font-size: 0.8rem;
        }

        .message.success {
            background: #f0fff4;
            color: #276749;
            border-color: #c6f6d5;
        }

        .message.error {
            background: #fff5f5;
            color: #c53030;
            border-color: #fed7d7;
        }

        .message.info {
            background: #ebf8ff;
            color: #2c5282;
            border-color: #bee3f8;
        }

        /* Main Admin Layout */
        .admin-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 1rem;
            height: calc(100vh - 250px);
            min-height: 400px;
        }

        /* Side Navigation */
        .side-nav {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            padding: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow: hidden;
        }

        .nav-header {
            padding: 0.5rem;
            border-bottom: 2px solid #f7fafc;
            margin-bottom: 0.5rem;
        }

        .nav-header h3 {
            font-size: 0.9rem;
            color: #2d3748;
            font-weight: 600;
        }

        .nav-header p {
            font-size: 0.7rem;
            color: #718096;
            margin-top: 0.2rem;
        }

        .nav-btn {
            background: none;
            border: none;
            text-align: left;
            padding: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            color: #4a5568;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: #f7fafc;
        }

        .nav-btn.active {
            background: #4299e1;
            color: white;
            font-weight: 600;
        }

        .nav-tools {
            margin-top: auto;
            padding-top: 0.8rem;
            border-top: 2px solid #f7fafc;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .tool-btn {
            background: #f8fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
            padding: 0.6rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .tool-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .tool-btn.primary {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .tool-btn.primary:hover {
            background: #3182ce;
        }

        /* Content Area */
        .content-area {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 400px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1rem;
            border-bottom: 2px solid #f7fafc;
            background: #f8fafc;
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .content-header h3 {
            font-size: 0.9rem;
            color: #2d3748;
            font-weight: 600;
        }

        .last-updated {
            font-size: 0.7rem;
            color: #718096;
        }

        .table-container {
            flex: 1;
            overflow: auto;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .inventory-table th {
            background: #f8fafc;
            padding: 0.6rem;
            text-align: left;
            color: #718096;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .inventory-table td {
            padding: 0.6rem;
            border-bottom: 1px solid #f7fafc;
            color: #4a5568;
            font-size: 0.8rem;
            vertical-align: middle;
        }

        .inventory-table tr:hover {
            background: #f8fafc;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: inline-block;
        }

        .status-in-stock {
            background: #c6f6d5;
            color: #276749;
        }

        .status-low-stock {
            background: #fed7d7;
            color: #c53030;
        }

        .status-out-of-stock {
            background: #e2e8f0;
            color: #718096;
        }

        /* Code Badge */
        .code-badge {
            background: #4299e1;
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            font-family: monospace;
            display: inline-block;
            white-space: nowrap;
        }

        /* Footer Note */
        .footer-note {
            background: white;
            border-radius: 8px;
            padding: 0.8rem 1rem;
            margin-top: 1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .footer-note h4 {
            font-size: 0.85rem;
            color: #2d3748;
            margin-bottom: 0.3rem;
            font-weight: 600;
        }

        .footer-note p {
            font-size: 0.75rem;
            color: #718096;
        }

        /* Loading States */
        .loading {
            color: #a0aec0;
            font-style: italic;
            font-size: 0.8rem;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #a0aec0;
        }

        .empty-state h3 {
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
            color: #718096;
        }

        /* Add Items Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: #1a365d;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.2rem;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
        }

        .modal-section {
            margin-bottom: 1.5rem;
        }

        .modal-section h4 {
            font-size: 0.9rem;
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 0.8rem;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            color: #4a5568;
            margin-bottom: 0.3rem;
            font-weight: 500;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #2c3e50;
            background: white;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #4a5568;
            cursor: pointer;
        }

        .checkbox-input {
            width: 16px;
            height: 16px;
            border: 2px solid #cbd5e0;
            border-radius: 4px;
            cursor: pointer;
        }

        .checkbox-input:checked {
            background: #4299e1;
            border-color: #4299e1;
        }

        .modal-footer {
            background: #f8fafc;
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 0.8rem;
        }

        .modal-btn {
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .modal-btn.primary {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .modal-btn.primary:hover {
            background: #3182ce;
        }

        .modal-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
            border-color: #cbd5e0;
        }

        .modal-btn.secondary:hover {
            background: #cbd5e0;
        }

        .preview-box {
            background: #f8fafc;
            border: 1px dashed #cbd5e0;
            border-radius: 6px;
            padding: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.75rem;
            color: #4a5568;
        }

        .preview-item {
            padding: 0.3rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .preview-item:last-child {
            border-bottom: none;
        }

        .modal-progress {
            display: none;
            align-items: center;
            gap: 0.8rem;
            margin-top: 1rem;
            padding: 0.8rem;
            background: #ebf8ff;
            border-radius: 6px;
            border: 1px solid #bee3f8;
        }

        .modal-progress.active {
            display: flex;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #4299e1;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.75rem;
            color: #2c5282;
            font-weight: 500;
            min-width: 60px;
            text-align: right;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .admin-container {
                grid-template-columns: 200px 1fr;
                gap: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar.collapsed {
                width: 250px;
                min-width: 250px;
                transform: translateX(-100%);
            }

            .sidebar.collapsed.open {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: none;
            }

            .mobile-menu-toggle {
                display: flex;
                background: #4299e1;
                color: white;
                border: none;
                width: 32px;
                height: 32px;
                border-radius: 6px;
                cursor: pointer;
                align-items: center;
                justify-content: center;
                font-size: 0.9rem;
            }

            .header-left {
                gap: 0.5rem;
            }

            .admin-container {
                grid-template-columns: 1fr;
                height: auto;
                min-height: 0;
            }

            .side-nav {
                order: 2;
                margin-top: 1rem;
            }

            .content-area {
                order: 1;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.8rem;
            }

            .user-info {
                width: 100%;
                justify-content: space-between;
            }

            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .table-container {
                max-height: 50vh;
            }

            .modal {
                max-height: 95vh;
            }
        }

        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .header-left {
                flex-direction: column;
                align-items: flex-start;
            }

            .user-info {
                width: 100%;
                justify-content: space-between;
            }

            .inventory-table {
                min-width: 800px;
            }

            .content-header h3 {
                font-size: 0.8rem;
            }

            .last-updated {
                font-size: 0.65rem;
            }

            .modal-footer {
                flex-direction: column;
            }

            .modal-btn {
                width: 100%;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-toggle {
                display: none;
            }
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            backdrop-filter: blur(3px);
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Scrollbar Styling */
        .table-container::-webkit-scrollbar,
        .side-nav::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .table-container::-webkit-scrollbar-track,
        .side-nav::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb,
        .side-nav::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover,
        .side-nav::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* Custom sidebar scrollbar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #2d3748;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
    </style>
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Add Items Modal -->
    <div class="modal-overlay" id="addItemsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add New Items to Warehouse</h3>
                <button class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h4>Item Details</h4>
                    <div class="form-group">
                        <label class="form-label">Paste Items List</label>
                        <textarea class="form-textarea" id="itemsTextarea" placeholder="Paste your items list here... Format: Item Name kPrice
Example:
Protea chargers k50
Gotv remotes k100
Dstv remotes k100"></textarea>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h4>Settings</h4>
                    <div class="form-group">
                        <label class="form-label">Initial Stock Quantity</label>
                        <input type="number" class="form-input" id="initialStock" value="0" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="itemCategory">
                            <option value="electronics">Electronics</option>
                            <option value="phones">Phones</option>
                            <option value="accessories">Accessories</option>
                            <option value="audio">Audio</option>
                            <option value="storage">Storage</option>
                            <option value="stationery">Stationery</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Add to Branches</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox-input" id="branch1Check" checked>
                                <span>Branch 1 (Main)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox-input" id="branch2Check" checked>
                                <span>Branch 2</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox-input" id="branch3Check" checked>
                                <span>Branch 3</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h4>Preview (Items to Add)</h4>
                    <div class="preview-box" id="previewBox">
                        <div class="preview-item">No items preview yet...</div>
                    </div>
                </div>
                
                <div class="modal-progress" id="progressSection">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="cancelBtn">Cancel</button>
                <button class="modal-btn primary" id="addItemsBtn">Add Items to Warehouse</button>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="sidebar-title">Navigation</div>
            <div class="nav-menu">
                <a href="admin-dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="branches.html" class="nav-item">
                    <i class="fas fa-building"></i>
                    <span>Branches</span>
                </a>
                <a href="grv.html" class="nav-item">
                    <i class="fas fa-upload"></i>
                    <span>Add Stock</span>
                </a>
                <a href="admin-warehouse.html" class="nav-item active">
                    <i class="fas fa-warehouse"></i>
                    <span>Warehouse</span>
                </a>
                <a href="admin-sales.html" class="nav-item">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Sales</span>
                </a>
                <a href="admin-reports.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="admin-cashflow.html" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Cash Flow</span>
                </a>
                <button class="nav-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <button class="mobile-menu-toggle" id="mobileMenuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1>Wamz Arts & Prints - Admin Warehouse</h1>
                </div>
                <div class="user-info">
                    <span class="user-name">Welcome, <strong id="currentUser">Admin</strong></span>
                    <span class="admin-badge">ADMIN</span>
                    <button class="grv-btn" id="grvBtn">
                        <i class="fas fa-upload"></i> GRV
                    </button>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Welcome Banner -->
            <div class="welcome-banner">
                <h2>Admin Warehouse Management</h2>
                <p>Real-time inventory tracking across all branches</p>
            </div>

            <!-- Message Display -->
            <div class="message" id="message"></div>

            <!-- Main Admin Area -->
            <div class="admin-container">
                <!-- Side Navigation -->
                <div class="side-nav">
                    <div class="nav-header">
                        <h3>Warehouse Views</h3>
                        <p>Real-time Firestore-backed inventory</p>
                    </div>
                    
                    <button class="nav-btn active" data-view="all">
                        <i class="fas fa-chart-bar"></i>
                        <span>All Branches</span>
                    </button>
                    <button class="nav-btn" data-view="branch1">
                        <i class="fas fa-building"></i>
                        <span>Branch 1 (Main)</span>
                    </button>
                    <button class="nav-btn" data-view="branch2">
                        <i class="fas fa-building"></i>
                        <span>Branch 2</span>
                    </button>
                    <button class="nav-btn" data-view="branch3">
                        <i class="fas fa-building"></i>
                        <span>Branch 3</span>
                    </button>
                    
                    <div class="nav-tools">
                        <button class="tool-btn" id="exportViewCsv">
                            <i class="fas fa-file-export"></i>
                            <span>Export CSV</span>
                        </button>
                        <button class="tool-btn primary" id="addItemsBtnSidebar">
                            <i class="fas fa-plus-circle"></i>
                            <span>Add New Items</span>
                        </button>
                        <button class="tool-btn" id="refreshBtn">
                            <i class="fas fa-sync"></i>
                            <span>Refresh</span>
                        </button>
                        <div style="font-size: 0.7rem; color: #718096; text-align: center; margin-top: 0.3rem;">
                            Real-time Firestore updates
                        </div>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="content-area">
                    <div class="content-header">
                        <h3 id="viewTitle">All Branches (Consolidated)</h3>
                        <div class="last-updated">
                            Last update: <span id="lastUpdated">â€”</span>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="inventory-table" id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Branch Qty</th>
                                    <th>Total Qty</th>
                                    <th>Unit Price</th>
                                    <th>Value</th>
                                    <th>Location(s)</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryBody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 2rem;">
                                        <span class="loading">Connecting to Firestore...</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Footer Note -->
            <div class="footer-note">
                <h4>Notes</h4>
                <p>This admin page uses Firestore for live inventory monitoring. Use the "Add New Items" button to batch add items to all branches.</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDTslfW2YQOw1XqiTn4RgTNKusi4w6NcHI",
            authDomain: "wamz-arts-and-prints.firebaseapp.com",
            projectId: "wamz-arts-and-prints",
            storageBucket: "wamz-arts-and-prints.firebasestorage.app",
            messagingSenderId: "495100135771",
            appId: "1:495100135771:web:d63ab48db021b4b02c327e",
            measurementId: "G-1HL55EC1D1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // State variables
        let unsubscribe = null;
        let lastSnapshotTs = null;
        let rawDocs = [];
        let currentView = 'all';
        let isAdmin = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log("ðŸ¬ Admin Warehouse loaded");
            initializeSidebar();
            checkAccess();
            setupUI();
            setupInventoryListener();
            setupModal();
        });

        // Initialize sidebar toggle for both desktop and mobile
        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const overlay = document.getElementById('sidebarOverlay');
            
            // Load saved sidebar state
            const savedState = localStorage.getItem('sidebarCollapsed');
            if (savedState === 'true') {
                sidebar.classList.add('collapsed');
            }
            
            // Desktop sidebar toggle
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
            });
            
            // Mobile menu toggle
            mobileMenuToggle.addEventListener('click', () => {
                sidebar.classList.add('open');
                overlay.classList.add('active');
            });
            
            // Close sidebar on overlay click (mobile)
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            });
            
            // Close sidebar when clicking on links (mobile)
            document.querySelectorAll('.nav-item').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('open');
                        overlay.classList.remove('active');
                    }
                });
            });
        }

        // Check admin access
        function checkAccess() {
            const cur = localStorage.getItem('currentUser');
            if (!cur) {
                window.location.href = 'index.html';
                return;
            }
            
            const u = JSON.parse(cur);
            if (u.username !== 'Wamz') {
                window.location.href = 'user-dashboard.html';
                return;
            }
            
            isAdmin = true;
            document.getElementById('currentUser').textContent = u.username;
        }

        // Setup UI event listeners
        function setupUI() {
            // Navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentView = this.getAttribute('data-view');
                    refreshCurrentView();
                });
            });
            
            // Tool buttons
            document.getElementById('exportViewCsv').addEventListener('click', exportCurrentViewCsv);
            document.getElementById('refreshBtn').addEventListener('click', refreshCurrentView);
            document.getElementById('grvBtn').addEventListener('click', () => window.location.href = 'grv.html');
            document.getElementById('addItemsBtnSidebar').addEventListener('click', showAddItemsModal);
        }

        // Setup modal functionality
        function setupModal() {
            const modal = document.getElementById('addItemsModal');
            const closeBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const addItemsBtn = document.getElementById('addItemsBtn');
            const itemsTextarea = document.getElementById('itemsTextarea');
            
            // Show modal
            window.showAddItemsModal = function() {
                modal.classList.add('active');
                // Pre-populate with your items list
                itemsTextarea.value = `Protea chargers k50
Gotv remotes k100
Dstv remotes k100
Tv remotes k150
Mango pods k250
Pods k150
Teckno chargers k130
ORG Chargers k150
Sky max chargers type c k150
Sivia cables iPhone k70
Sivia cables normal k70
Sivia cables type c k70
Itel original small batteries k80
Venus original small batteries k80
OTG K40
Car modulators k150
Mango headset k70
Av cables k50
Aux av k50
Aux cables k35
Ipone complete chargers k350
Mango car chargers k150
Mango pod casings k80
Card reders k25
Mp3 k100
Travel chargers k100
Samsung 45w chargers type c tp c k350
P47 betsheadsets k150
Oking phones k280
Callus phones k280
Nokia phones 106 k400
Nokia phones 105 k350
Itel original phones k350
Venus phones k350
2gb flash k75
4gb flash k85
HDMI cables k70
C to C cables k100
C to c and impone cables k100
Mouse k50
Nomal cables k50
Type c data cables k50
Iphone cables k50
Aux car cabele k35
Rims of papers k150
Key bolds k150
Mifi mini mtn k600
Ticno chargers type c k80
Ticno chargers normal k80
Next chargers k150
Samsung chargers k50
Screen protectors k35
Screen protectors k70
Screen protectors k100
Privacy screen protectors k150
Evelops small k3
Evelops medium k5
Evelops big k7
Pens k2
Passport size papes photos k50
Headsets k35
Headsets k40
Airtel simcards k15
Mtn sim cards k15
Zedmobile sim cards k15
ZAMTEL SIM card k20`;
                updatePreview();
            };
            
            // Close modal
            closeBtn.addEventListener('click', () => modal.classList.remove('active'));
            cancelBtn.addEventListener('click', () => modal.classList.remove('active'));
            
            // Update preview when textarea changes
            itemsTextarea.addEventListener('input', updatePreview);
            
            // Add items button
            addItemsBtn.addEventListener('click', processAndAddItems);
            
            // Close modal on ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                }
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        }
        
        // Update preview box
        function updatePreview() {
            const textarea = document.getElementById('itemsTextarea');
            const previewBox = document.getElementById('previewBox');
            const items = parseItemsText(textarea.value);
            
            if (items.length === 0) {
                previewBox.innerHTML = '<div class="preview-item">No items preview yet...</div>';
                return;
            }
            
            let previewHTML = '';
            items.slice(0, 10).forEach((item, index) => {
                previewHTML += `<div class="preview-item">${index + 1}. ${item.name} - ZMW ${item.price.toFixed(2)}</div>`;
            });
            
            if (items.length > 10) {
                previewHTML += `<div class="preview-item">... and ${items.length - 10} more items</div>`;
            }
            
            previewBox.innerHTML = previewHTML;
        }
        
        // Parse items text
        function parseItemsText(text) {
            const items = [];
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                // Extract price (look for "k" followed by numbers)
                const priceMatch = trimmed.match(/k(\d+(\.\d+)?)$/i);
                if (priceMatch) {
                    const price = parseFloat(priceMatch[1]);
                    const name = trimmed.substring(0, trimmed.lastIndexOf(priceMatch[0])).trim();
                    
                    if (name && !isNaN(price)) {
                        items.push({
                            name: name,
                            price: price,
                            category: detectCategory(name)
                        });
                    }
                } else {
                    // Try to find price in other formats
                    const numberMatch = trimmed.match(/\d+(\.\d+)?$/);
                    if (numberMatch) {
                        const price = parseFloat(numberMatch[0]);
                        const name = trimmed.substring(0, trimmed.lastIndexOf(numberMatch[0])).trim();
                        
                        if (name && !isNaN(price)) {
                            items.push({
                                name: name,
                                price: price,
                                category: detectCategory(name)
                            });
                        }
                    } else {
                        // Add without price
                        items.push({
                            name: trimmed,
                            price: 0,
                            category: detectCategory(trimmed)
                        });
                    }
                }
            }
            
            return items;
        }
        
        // Detect category from item name
        function detectCategory(name) {
            const lowerName = name.toLowerCase();
            
            if (lowerName.includes('phone') || lowerName.includes('nokia') || lowerName.includes('itel') || 
                lowerName.includes('venus') || lowerName.includes('oking') || lowerName.includes('callus')) {
                return 'phones';
            } else if (lowerName.includes('charger') || lowerName.includes('cable') || lowerName.includes('adapter') || 
                       lowerName.includes('battery') || lowerName.includes('otg') || lowerName.includes('hdmi') || 
                       lowerName.includes('av cable') || lowerName.includes('aux') || lowerName.includes('mouse') || 
                       lowerName.includes('card reader') || lowerName.includes('mp3') || lowerName.includes('modulator') ||
                       lowerName.includes('mifi')) {
                return 'electronics';
            } else if (lowerName.includes('headset') || lowerName.includes('earphone') || lowerName.includes('audio') || 
                       lowerName.includes('pod') || lowerName.includes('headphone')) {
                return 'audio';
            } else if (lowerName.includes('flash') || lowerName.includes('memory') || lowerName.includes('storage')) {
                return 'storage';
            } else if (lowerName.includes('sim') || lowerName.includes('simcard')) {
                return 'simcards';
            } else if (lowerName.includes('paper') || lowerName.includes('envelop') || lowerName.includes('pen') || 
                       lowerName.includes('rim') || lowerName.includes('key bold')) {
                return 'stationery';
            } else if (lowerName.includes('screen protector')) {
                return 'accessories';
            } else if (lowerName.includes('photo') || lowerName.includes('picture')) {
                return 'services';
            }
            
            return 'other';
        }
        
        // Process and add items to database
        async function processAndAddItems() {
            const textarea = document.getElementById('itemsTextarea');
            const initialStock = parseInt(document.getElementById('initialStock').value) || 0;
            const category = document.getElementById('itemCategory').value;
            const progressSection = document.getElementById('progressSection');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // Get selected branches
            const selectedBranches = [];
            if (document.getElementById('branch1Check').checked) selectedBranches.push('branch1');
            if (document.getElementById('branch2Check').checked) selectedBranches.push('branch2');
            if (document.getElementById('branch3Check').checked) selectedBranches.push('branch3');
            
            if (selectedBranches.length === 0) {
                showMessage('Please select at least one branch', 'error');
                return;
            }
            
            const items = parseItemsText(textarea.value);
            
            if (items.length === 0) {
                showMessage('No valid items found. Check the format.', 'error');
                return;
            }
            
            // Show progress
            progressSection.classList.add('active');
            progressFill.style.width = '0%';
            progressText.textContent = '0%';
            
            let addedCount = 0;
            let errorCount = 0;
            
            try {
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    const itemCategory = item.category || category;
                    
                    // Generate code from name
                    const code = generateCodeFromName(item.name);
                    
                    for (const branchId of selectedBranches) {
                        try {
                            // Create item data
                            const itemData = {
                                code: code,
                                name: item.name,
                                category: itemCategory,
                                price: item.price,
                                stock: initialStock,
                                branchId: branchId,
                                location: 'Warehouse',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            
                            // Add to Firestore
                            await db.collection('inventory').add(itemData);
                            addedCount++;
                        } catch (err) {
                            console.error(`Error adding ${item.name} to ${branchId}:`, err);
                            errorCount++;
                        }
                    }
                    
                    // Update progress
                    const progress = Math.round((i + 1) / items.length * 100);
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `${progress}%`;
                }
                
                // Complete
                progressFill.style.width = '100%';
                progressText.textContent = '100%';
                
                // Show success message
                showMessage(`Successfully added ${addedCount} item entries across ${selectedBranches.length} branch(es). ${errorCount} errors.`, 'success');
                
                // Close modal after delay
                setTimeout(() => {
                    document.getElementById('addItemsModal').classList.remove('active');
                    progressSection.classList.remove('active');
                    
                    // Refresh inventory view
                    if (unsubscribe) {
                        setupInventoryListener();
                    }
                }, 1500);
                
            } catch (error) {
                console.error('Batch add error:', error);
                showMessage(`Error adding items: ${error.message}`, 'error');
                progressSection.classList.remove('active');
            }
        }
        
        // Generate code from name
        function generateCodeFromName(name) {
            // Remove special characters and extra spaces
            const cleanName = name.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
            
            // Get first letters of words
            const words = cleanName.split(' ');
            let code = '';
            
            if (words.length === 1) {
                // Single word: take first 4 letters
                code = words[0].substring(0, 4).toUpperCase();
            } else if (words.length === 2) {
                // Two words: first 2 letters of each
                code = (words[0].substring(0, 2) + words[1].substring(0, 2)).toUpperCase();
            } else {
                // Multiple words: first letter of first 3 words
                code = words.slice(0, 3).map(w => w.charAt(0)).join('').toUpperCase();
            }
            
            // Add timestamp for uniqueness
            const timestamp = Date.now().toString().slice(-4);
            return code + timestamp;
        }

        // Setup real-time Firestore listener
        function setupInventoryListener() {
            console.log("ðŸ” Setting up Firestore listener...");
            
            if (unsubscribe) {
                unsubscribe();
            }
            
            const q = db.collection('inventory');
            
            unsubscribe = q.onSnapshot(snapshot => {
                rawDocs = [];
                snapshot.forEach(doc => {
                    const data = Object.assign({}, doc.data());
                    data._id = doc.id;
                    data.branchId = data.branchId || data.branch || data.branch_id || 'branch1';
                    data.code = (data.code || '').toString();
                    data.name = data.name || '';
                    data.category = data.category || 'other';
                    data.qty = parseInt(data.stock || data.qty || data.quantity || 0, 10) || 0;
                    data.price = parseFloat(data.price || data.unitPrice || 0) || 0;
                    data.location = data.location || data.locations || '';
                    rawDocs.push(data);
                });

                lastSnapshotTs = Date.now();
                document.getElementById('lastUpdated').textContent = new Date(lastSnapshotTs).toLocaleString();
                refreshCurrentView();
                
                console.log(`ðŸ“¦ Updated: ${rawDocs.length} items loaded`);
                
            }, err => {
                console.error('Firestore listener error:', err);
                const tbody = document.getElementById('inventoryBody');
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:2rem;color:#c53030; font-size: 0.8rem;">Error loading inventory: ${err.message}</td></tr>`;
            });
        }

        // Build aggregated map for consolidated view
        function buildAggregatedMap() {
            const map = {};
            rawDocs.forEach(item => {
                const code = (item.code || '').toUpperCase();
                if (!code) return;
                
                if (!map[code]) {
                    map[code] = {
                        code,
                        name: item.name || code,
                        category: item.category || 'other',
                        price: item.price || 0,
                        total: 0,
                        branches: {},
                        locations: new Set()
                    };
                }
                
                const rec = map[code];
                const q = Number(item.qty || 0);
                rec.total += q;
                rec.branches[item.branchId] = (rec.branches[item.branchId] || 0) + q;
                
                if (item.location) {
                    if (Array.isArray(item.location)) {
                        item.location.forEach(l => rec.locations.add(l));
                    } else {
                        rec.locations.add(item.location);
                    }
                }
                
                if ((!rec.price || rec.price === 0) && item.price) {
                    rec.price = item.price;
                }
            });
            return map;
        }

        // Render consolidated view
        function renderConsolidated() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            
            const map = buildAggregatedMap();
            const rows = Object.values(map).sort((a, b) => b.total - a.total || a.code.localeCompare(b.code));
            
            if (!rows.length) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:2rem; font-size: 0.8rem; color: #718096;">No items found</td></tr>`;
                return;
            }
            
            rows.forEach(r => {
                const tr = document.createElement('tr');
                const locations = Array.from(r.locations).join('; ');
                const price = Number(r.price || 0);
                const value = price * r.total;
                
                tr.innerHTML = `
                    <td><span class="code-badge">${escapeHtml(r.code)}</span></td>
                    <td>${escapeHtml(r.name)}</td>
                    <td>${capitalize(r.category)}</td>
                    <td>${formatBranchQtys(r.branches)}</td>
                    <td>${numberWithCommas(r.total)}</td>
                    <td>${formatZMW(price)}</td>
                    <td>${formatZMW(value)}</td>
                    <td style="font-size: 0.75rem;">${escapeHtml(locations)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Render single branch view
        function renderBranch(branchId) {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            
            const list = rawDocs.filter(d => d.branchId === branchId);
            
            if (!list.length) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:2rem; font-size: 0.8rem; color: #718096;">No items for ${branchId}</td></tr>`;
                return;
            }
            
            const map = {};
            list.forEach(item => {
                const code = (item.code || '').toUpperCase();
                if (!code) return;
                
                if (!map[code]) {
                    map[code] = {
                        code,
                        name: item.name || code,
                        category: item.category || 'other',
                        price: item.price || 0,
                        qty: 0,
                        locations: new Set()
                    };
                }
                
                map[code].qty += Number(item.qty || 0);
                
                if (item.location) {
                    if (Array.isArray(item.location)) {
                        item.location.forEach(l => map[code].locations.add(l));
                    } else {
                        map[code].locations.add(item.location);
                    }
                }
            });
            
            Object.values(map)
                .sort((a, b) => b.qty - a.qty || a.code.localeCompare(b.code))
                .forEach(it => {
                    const tr = document.createElement('tr');
                    const val = Number(it.price || 0) * Number(it.qty || 0);
                    
                    tr.innerHTML = `
                        <td><span class="code-badge">${escapeHtml(it.code)}</span></td>
                        <td>${escapeHtml(it.name)}</td>
                        <td>${capitalize(it.category)}</td>
                        <td>-</td>
                        <td>${numberWithCommas(it.qty)}</td>
                        <td>${formatZMW(it.price)}</td>
                        <td>${formatZMW(val)}</td>
                        <td style="font-size: 0.75rem;">${escapeHtml(Array.from(it.locations).join('; '))}</td>
                    `;
                    tbody.appendChild(tr);
                });
        }

        // Refresh current view
        function refreshCurrentView() {
            const viewTitle = document.getElementById('viewTitle');
            
            if (currentView === 'all') {
                viewTitle.textContent = 'All Branches (Consolidated)';
                renderConsolidated();
            } else {
                viewTitle.textContent = `${currentView} Inventory`;
                renderBranch(currentView);
            }
            
            document.getElementById('lastUpdated').textContent = lastSnapshotTs 
                ? new Date(lastSnapshotTs).toLocaleString() 
                : 'â€”';
        }

        // Export current view to CSV
        function exportCurrentViewCsv() {
            let rows = [];
            
            if (currentView === 'all') {
                const map = buildAggregatedMap();
                rows.push(['code', 'name', 'category', 'branch1_qty', 'branch2_qty', 'branch3_qty', 'total_qty', 'unit_price', 'value', 'locations']);
                
                Object.values(map).forEach(m => {
                    rows.push([
                        m.code,
                        m.name,
                        m.category,
                        m.branches.branch1 || 0,
                        m.branches.branch2 || 0,
                        m.branches.branch3 || 0,
                        m.total,
                        (m.price || 0).toFixed(2),
                        ((m.price || 0) * m.total).toFixed(2),
                        Array.from(m.locations).join('; ')
                    ]);
                });
            } else {
                rows.push(['code', 'name', 'category', 'qty', 'unit_price', 'value', 'locations']);
                const list = rawDocs.filter(d => d.branchId === currentView);
                const map = {};
                
                list.forEach(it => {
                    const c = it.code.toUpperCase();
                    if (!map[c]) {
                        map[c] = {
                            code: c,
                            name: it.name,
                            category: it.category,
                            qty: 0,
                            price: it.price || 0,
                            locations: new Set()
                        };
                    }
                    map[c].qty += Number(it.qty || 0);
                    if (it.location) map[c].locations.add(it.location);
                });
                
                Object.values(map).forEach(i => {
                    rows.push([
                        i.code,
                        i.name,
                        i.category,
                        i.qty,
                        (i.price || 0).toFixed(2),
                        ((i.qty || 0) * (i.price || 0)).toFixed(2),
                        Array.from(i.locations).join('; ')
                    ]);
                });
            }
            
            const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
            downloadTextFile(csv, `inventory-${currentView}-${new Date().toISOString().slice(0, 19)}.csv`);
            showMessage('CSV exported successfully', 'success');
        }

        // Utility functions
        function formatZMW(n) {
            return 'ZMW ' + Number(n || 0).toLocaleString('en-ZM', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function numberWithCommas(x) {
            return (x || 0).toLocaleString();
        }

        function capitalize(s) {
            return !s ? '' : s.charAt(0).toUpperCase() + s.slice(1);
        }

        function formatBranchQtys(obj) {
            const order = ['branch1', 'branch2', 'branch3'];
            return order.map(b => `${b.replace('branch', 'B')}:${numberWithCommas(obj[b] || 0)}`).join(' â€¢ ');
        }

        function downloadTextFile(text, filename) {
            const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Show message
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';

            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Logout function
        function logout() {
            if (unsubscribe) {
                unsubscribe();
            }
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        // Set dashboard start time
        window.dashboardStartTime = Date.now();

        // Auto-refresh listener every 5 minutes
        setInterval(() => {
            if (unsubscribe) {
                setupInventoryListener();
            }
        }, 300000); // 5 minutes
    </script>
</body>
</html>
