<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Wamz Arts & Prints - Branch Overview</title>

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
            height: 100vh;
            overflow-x: hidden;
        }

        /* Dashboard Layout */
        .dashboard-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: auto 1fr;
            height: 100vh;
            transition: grid-template-columns 0.3s ease;
        }

        .dashboard-container.sidebar-collapsed {
            grid-template-columns: 0px 1fr;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: #1a365d;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .sidebar-toggle {
            background: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .header h1 {
            font-size: 1.4rem;
            font-weight: 600;
            flex: 1;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-name {
            font-weight: 500;
            color: #e2e8f0;
        }

        .branch-badge {
            background: #4299e1;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .admin-badge {
            background: #e53e3e;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .logout-btn {
            background: #2d3748;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #4a5568;
        }

        /* Sidebar */
        .sidebar {
            background: #2d3748;
            color: white;
            padding: 2rem 0;
            border-right: 1px solid #4a5568;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .sidebar.collapsed {
            opacity: 0;
            transform: translateX(-100%);
        }

        .sidebar-title {
            font-size: 1rem;
            color: #cbd5e0;
            margin-bottom: 1.5rem;
            padding: 0 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            white-space: nowrap;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0 1rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.9rem 1rem;
            background: none;
            border: none;
            text-align: left;
            color: #cbd5e0;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-item.active {
            background: #4299e1;
            color: white;
        }

        .nav-icon {
            min-width: 20px;
            text-align: center;
        }

        /* Main Content Area */
        .main-content {
            background: #f5f7fa;
            padding: 2rem;
            overflow-y: auto;
            height: 100%;
        }

        /* Page Styles */
        :root {
            --bg: #f3f6fa;
            --card: #fff;
            --muted: #9ca3af;
            --accent: #1f2937;
            --brand: #2563eb;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e2e8f0;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }

        .page-header h2 {
            font-size: 1.6rem;
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #718096;
            font-size: 0.95rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-title {
            font-size: 0.9rem;
            color: #718096;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .stat-value.zmw {
            font-size: 1.6rem;
        }

        .stat-details {
            font-size: 0.9rem;
            color: #718096;
        }

        .zmw-symbol {
            font-size: 0.9rem;
            margin-right: 2px;
            color: #4299e1;
            font-weight: 600;
        }

        /* Main Content Layout */
        .content {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
            min-height: 0;
            overflow: hidden;
        }

        .left-panel {
            flex: 2;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow: hidden;
        }

        .right-panel {
            flex: 1;
            min-width: 300px;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow: auto;
        }

        /* Cards */
        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.1rem;
            color: #2d3748;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 0.25rem;
        }

        /* Search */
        .search-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        input.search {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 0.95rem;
            background: white;
        }

        input.search:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        /* Branches Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            overflow: auto;
            padding: 4px;
            min-height: 0;
        }

        .branch-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .branch-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .branch-top {
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .branch-name {
            font-weight: 700;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .branch-sub {
            font-size: 0.85rem;
            color: #718096;
        }

        /* Status Badges */
        .status {
            padding: 0.4rem 0.75rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .status.excellent {
            background: rgba(22, 163, 74, 0.12);
            color: var(--success);
        }

        .status.good {
            background: rgba(245, 158, 11, 0.12);
            color: var(--warning);
        }

        .status.bad {
            background: rgba(239, 68, 68, 0.12);
            color: var(--danger);
        }

        /* Metrics */
        .metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .metric {
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #eef6ff;
        }

        .m-title {
            font-size: 0.75rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .m-value {
            font-weight: 700;
            color: #2d3748;
            font-size: 1rem;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }

        .btn.ghost {
            background: transparent;
            color: #4299e1;
            border: 1px solid #4299e1;
        }

        .btn.ghost:hover {
            background: rgba(66, 153, 225, 0.1);
        }

        .btn.secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn.secondary:hover {
            background: #cbd5e0;
        }

        /* List Items */
        .small-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            overflow: auto;
            max-height: 400px;
            padding-right: 0.5rem;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            transition: all 0.2s;
        }

        .list-item:hover {
            border-color: #cbd5e0;
            background: white;
        }

        /* Sparkline */
        .spark {
            width: 100px;
            height: 32px;
        }

        svg {
            display: block;
        }

        /* Muted Text */
        .muted {
            color: #718096;
            font-size: 0.85rem;
        }

        /* Message Display */
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: none;
            border: 1px solid transparent;
        }

        .message.success {
            background: #f0fff4;
            color: #276749;
            border-color: #c6f6d5;
        }

        .message.error {
            background: #fff5f5;
            color: #c53030;
            border-color: #fed7d7;
        }

        .message.info {
            background: #ebf8ff;
            color: #2c5282;
            border-color: #bee3f8;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .content {
                flex-direction: column;
            }
            
            .right-panel {
                min-width: 100%;
            }
            
            .dashboard-container.sidebar-collapsed {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
                flex-wrap: wrap;
                gap: 0.75rem;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .user-info {
                width: 100%;
                justify-content: space-between;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Header -->
        <div class="header">
            <button class="sidebar-toggle" id="sidebarToggle" title="Toggle Sidebar">
                â˜°
            </button>
            <h1>Wamz Arts & Prints - Branch Overview</h1>
            <div class="user-info">
                <span class="user-name">Welcome, <strong id="currentUser">User</strong></span>
                <span class="branch-badge" id="branchBadge">Admin</span>
                <span class="admin-badge" id="adminBadge">ADMIN</span>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-title">Navigation</div>
            <div class="nav-menu">
                <a href="user-dashboard.html" class="nav-item">
                    <span class="nav-icon"></span>
                    <span>Dashboard</span>
                </a>
                <a href="admin-warehouse.html" class="nav-item">
                    <span class="nav-icon"></span>
                    <span>Warehouse</span>
                </a>
                <a href="grv.html" class="nav-item">
                    <span class="nav-icon"></span>
                    <span>GRV Upload</span>
                </a>
                <a href="branches.html" class="nav-item active">
                    <span class="nav-icon"></span>
                    <span>Branches</span>
                </a>
                <a href="reports.html" class="nav-item">
                    <span class="nav-icon"></span>
                    <span>Reports</span>
                </a>
                <a href="cashflow.html" class="nav-item">
                    <span class="nav-icon"></span>
                    <span>Cash Flow</span>
                </a>
                <a href="admin-panel.html" class="nav-item">
                    <span class="nav-icon">ðŸ”§</span>
                    <span>Admin Panel</span>
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="grv-container">
                <!-- Page Header -->
                <div class="page-header">
                    <div>
                        <h2>Branch Overview</h2>
                        <div class="page-subtitle">Overview of inventory & sales performance per branch â€” live from Firestore</div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">Total Branches</div>
                        <div class="stat-value" id="totalBranches">â€”</div>
                        <div class="stat-details">Active branches in system</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-title">Total Inventory Value</div>
                        <div class="stat-value zmw" id="totalValue">â€”</div>
                        <div class="stat-details">Estimated stock value across branches</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-title">30d Sales (All branches)</div>
                        <div class="stat-value zmw" id="sales30">â€”</div>
                        <div class="stat-details">Sum of sales in the last 30 days</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-title">Top Branch</div>
                        <div class="stat-value" id="topBranch">â€”</div>
                        <div class="stat-details">Best performing by 30d sales</div>
                    </div>
                </div>

                <div class="content">
                    <section class="left-panel">
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">Branches</div>
                                    <div class="card-subtitle">Click View / Open to inspect branch</div>
                                </div>
                                <div style="display: flex; gap: 0.75rem; align-items: center;">
                                    <div class="muted">Filter</div>
                                    <input id="filterInput" class="search" placeholder="Search branch name or id..." />
                                </div>
                            </div>

                            <div class="grid" id="grid" aria-live="polite">
                                <!-- Branch cards will be injected here -->
                            </div>
                        </div>
                    </section>

                    <aside class="right-panel">
                        <div class="card">
                            <div class="card-header">
                                <div style="font-weight: 600">Performance Highlights</div>
                                <div class="muted">Last 30 days</div>
                            </div>

                            <div class="small-list" id="highlights">
                                <!-- Dynamic highlights -->
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div style="font-weight: 600">Recent GRVs</div>
                            </div>
                            <div id="recentGrvs" class="small-list">
                                <div class="muted">Loading...</div>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase config (same as other pages)
        const firebaseConfig = {
            apiKey: "AIzaSyDTslfW2YQOw1XqiTn4RgTNKusi4w6NcHI",
            authDomain: "wamz-arts-and-prints.firebaseapp.com",
            projectId: "wamz-arts-and-prints",
            storageBucket: "wamz-arts-and-prints.firebasestorage.app",
            messagingSenderId: "495100135771",
            appId: "1:495100135771:web:d63ab48db021b4b02c327e",
            measurementId: "G-1HL55EC1D1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // state
        let currentUser = null;
        let branchMap = {}; // branchId => aggregated info
        let unsubInventory = null;
        let unsubSales = null;
        let unsubGrv = null;

        const gridEl = document.getElementById('grid');
        const filterEl = document.getElementById('filterInput');
        const highlightsEl = document.getElementById('highlights');
        const recentGrvsEl = document.getElementById('recentGrvs');

        // Sidebar Management
        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggle');
            const container = document.getElementById('dashboardContainer');
            
            // Load saved state
            const savedState = localStorage.getItem('sidebarCollapsed');
            const isCollapsed = savedState === 'true';
            
            if (isCollapsed) {
                sidebar.classList.add('collapsed');
                container.classList.add('sidebar-collapsed');
            }
            
            // Toggle sidebar
            toggleBtn.addEventListener('click', () => {
                const isCollapsed = sidebar.classList.toggle('collapsed');
                container.classList.toggle('sidebar-collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed.toString());
            });
        }

        // Format ZMW currency
        function formatZMW(n) { 
            return '<span class="zmw-symbol">ZMW</span>' + Number(n || 0).toLocaleString('en-ZM', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }); 
        }

        // Show message
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            if (!messageDiv) return;
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // access check (admin)
        (function checkAccess(){
            const cur = localStorage.getItem('currentUser');
            if (!cur) { window.location.href = 'index.html'; return; }
            const u = JSON.parse(cur);
            if (u.username !== 'Wamz' && u.role !== 'admin') { window.location.href = 'user-dashboard.html'; return; }
            currentUser = u;
            document.getElementById('currentUser').textContent = u.username;
            
            // Initialize sidebar
            initializeSidebar();
        })();

        // helpers
        function fmtZMW(n){ 
            return '<span class="zmw-symbol">ZMW</span>' + Number(n||0).toLocaleString('en-ZM', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }); 
        }
        
        function number(n){ return Number(n||0).toLocaleString() }
        function daysAgoDate(days){ const d = new Date(); d.setDate(d.getDate() - days); return d; }

        // Listen inventory to build per-branch inventory metrics
        function startInventoryListener(){
            if (unsubInventory) unsubInventory();
            unsubInventory = db.collection('inventory').onSnapshot(snap => {
                Object.keys(branchMap).forEach(k=>{
                    branchMap[k].totalItems = 0;
                    branchMap[k].totalValue = 0;
                    branchMap[k].codes = new Set();
                    branchMap[k].lowStockCount = 0;
                    branchMap[k].outOfStockCount = 0;
                });
                snap.forEach(doc => {
                    const d = doc.data();
                    const branchId = d.branchId || d.branch || d.branch_id || 'branch1';
                    const code = (d.code || '').toString().toUpperCase();
                    const qty = parseInt(d.stock || d.qty || d.quantity || 0,10) || 0;
                    const price = parseFloat(d.price || d.unitPrice || 0) || 0;
                    if (!branchMap[branchId]) {
                        branchMap[branchId] = createEmptyBranch(branchId);
                    }
                    const b = branchMap[branchId];
                    b.codes.add(code);
                    b.totalItems += qty;
                    b.totalValue += qty * price;
                    if (qty === 0) b.outOfStockCount++;
                    else if (qty <= 5) b.lowStockCount++;
                });
                Object.values(branchMap).forEach(b => b.uniqueCodes = b.codes.size);
                renderAll();
            }, err => console.error('inventory listen error', err));
        }

        // Listen sales to compute last 30/30 comparison and daily series (last 30 days)
        function startSalesListener(){
            if (unsubSales) unsubSales();
            const from = firebase.firestore.Timestamp.fromDate(daysAgoDate(90));
            unsubSales = db.collection('sales').where('timestamp','>=', from).onSnapshot(snap => {
                Object.values(branchMap).forEach(b => { b.sales = []; b.sales30 = 0; b.salesPrev30 = 0; b.daily = {}; });
                snap.forEach(doc => {
                    const d = doc.data();
                    const branchId = d.branchId || d.branch || 'branch1';
                    const amount = parseFloat(d.amount || d.total || 0) || 0;
                    const ts = d.timestamp ? (d.timestamp.toDate ? d.timestamp.toDate() : new Date(d.timestamp)) : new Date();
                    if (!branchMap[branchId]) branchMap[branchId] = createEmptyBranch(branchId);
                    const b = branchMap[branchId];
                    b.sales.push({ amount, ts });
                    const day = ts.toISOString().slice(0,10);
                    b.daily[day] = (b.daily[day] || 0) + amount;
                });

                const now = new Date();
                const start30 = daysAgoDate(30);
                const start60 = daysAgoDate(60);
                Object.values(branchMap).forEach(b=>{
                    b.sales30 = 0; b.salesPrev30 = 0;
                    (b.sales || []).forEach(s=>{
                        const t = s.ts;
                        if (t >= start30) b.sales30 += s.amount;
                        else if (t >= start60 && t < start30) b.salesPrev30 += s.amount;
                    });
                    b.spark = getDailySeries(b.daily, 14);
                    b.growth = b.salesPrev30 > 0 ? ((b.sales30 - b.salesPrev30) / b.salesPrev30) * 100 : (b.sales30 > 0 ? 100 : 0);
                    if (b.growth >= 10) b.status = 'excellent';
                    else if (b.growth >= 0) b.status = 'good';
                    else b.status = 'bad';
                });
                renderAll();
            }, err => console.error('sales listen error', err));
        }

        // listen recent GRVs for right panel
        function startGrvListener(){
            if (unsubGrv) unsubGrv();
            unsubGrv = db.collection('grvHistory').orderBy('ts','desc').limit(8).onSnapshot(snap=>{
                recentGrvsEl.innerHTML = '';
                if (snap.empty) { 
                    recentGrvsEl.innerHTML = '<div class="muted">No GRVs yet.</div>'; 
                    return; 
                }
                snap.forEach(doc=>{
                    const d = doc.data();
                    const ts = d.processedAt ? new Date(d.processedAt) : (d.ts && d.ts.toDate ? d.ts.toDate() : new Date());
                    const el = document.createElement('div'); 
                    el.className='list-item';
                    el.innerHTML = `
                        <div>
                            <div style="font-weight:600">${ts.toLocaleDateString()}</div>
                            <div class="muted">${ts.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} â€¢ ${(d.rowsCount||0)} items</div>
                        </div>
                        <div>
                            <button class="btn ghost" onclick='downloadGrv("${doc.id}")' style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">CSV</button>
                        </div>
                    `;
                    recentGrvsEl.appendChild(el);
                });
            }, err => recentGrvsEl.innerHTML = `<div class="muted">Error: ${err.message}</div>`)
        }

        // helpers
        function createEmptyBranch(id){
            return {
                id,
                displayName: id === 'branch1' ? 'Branch 1 (Main)' : (id === 'branch2' ? 'Branch 2' : 'Branch 3'),
                totalItems: 0,
                totalValue: 0,
                lowStockCount: 0,
                outOfStockCount: 0,
                codes: new Set(),
                uniqueCodes: 0,
                sales: [],
                sales30: 0,
                salesPrev30:0,
                spark: [],
                growth: 0,
                status: 'good'
            };
        }

        function getDailySeries(dailyMap, days){
            const arr = [];
            for(let i=days-1;i>=0;i--){
                const d = daysAgoDate(i).toISOString().slice(0,10);
                arr.push(dailyMap[d] || 0);
            }
            return arr;
        }

        // Render everything
        function renderAll(){
            const branches = Object.values(branchMap);
            document.getElementById('totalBranches').textContent = branches.length;
            const totalValue = branches.reduce((s,b)=>s + (b.totalValue || 0), 0);
            document.getElementById('totalValue').innerHTML = formatZMW(totalValue);
            const total30 = branches.reduce((s,b)=>s + (b.sales30 || 0), 0);
            document.getElementById('sales30').innerHTML = formatZMW(total30);
            const top = branches.slice().sort((a,b)=> (b.sales30||0) - (a.sales30||0))[0];
            document.getElementById('topBranch').textContent = top ? top.displayName : 'â€”';

            renderGrid();
            renderHighlights();
        }

        function renderGrid(){
            const filter = (filterEl.value || '').toLowerCase().trim();
            const branches = Object.values(branchMap).sort((a,b)=> (b.sales30 || b.totalValue) - (a.sales30 || a.totalValue));
            gridEl.innerHTML = '';
            if (!branches.length) {
                gridEl.innerHTML = `<div class="muted" style="text-align: center; padding: 2rem;">No branches found.</div>`;
                return;
            }
            branches.filter(b=>{
                if (!filter) return true;
                return b.id.toLowerCase().includes(filter) || (b.displayName||'').toLowerCase().includes(filter);
            }).forEach(b=>{
                const card = document.createElement('div'); 
                card.className='branch-card';
                card.innerHTML = `
                    <div class="branch-top">
                        <div>
                            <div class="branch-name">${b.displayName}</div>
                            <div class="branch-sub">ID: ${b.id}</div>
                        </div>
                        <div style="text-align:right">
                            <div class="status ${b.status === 'excellent' ? 'excellent' : b.status === 'good' ? 'good' : 'bad'}">
                                ${b.status === 'excellent' ? 'Excellent' : b.status === 'good' ? 'Good' : 'Needs attention'}
                            </div>
                            <div class="muted" style="font-size:0.85rem;margin-top:6px">30d sales: ${fmtZMW(b.sales30)}</div>
                        </div>
                    </div>

                    <div class="metrics">
                        <div class="metric"><div class="m-title">Total qty</div><div class="m-value">${number(b.totalItems)}</div></div>
                        <div class="metric"><div class="m-title">Unique SKUs</div><div class="m-value">${b.uniqueCodes}</div></div>
                        <div class="metric"><div class="m-title">Inventory value</div><div class="m-value">${fmtZMW(b.totalValue)}</div></div>
                        <div class="metric"><div class="m-title">Low stock</div><div class="m-value">${b.lowStockCount}</div></div>
                    </div>

                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem">
                        <div class="muted">Growth: ${b.growth ? b.growth.toFixed(1) + '%' : 'â€”'}</div>
                        <div class="actions">
                            <button class="btn ghost" data-branch="${b.id}" onclick="viewBranch(event)">View</button>
                            <button class="btn" data-branch="${b.id}" onclick="openWarehouse(event)">Open</button>
                        </div>
                    </div>

                    <div style="margin-top:1rem;display:flex;justify-content:flex-end">
                        ${renderSparkline(b.spark || [])}
                    </div>
                `;
                gridEl.appendChild(card);
            });
        }

        function renderSparkline(values){
            if (!values || !values.length) return `<div style="font-size:0.85rem;color:#718096">No data</div>`;
            const w=100,h=32, pad=2;
            const max = Math.max(...values,1);
            const min = Math.min(...values);
            const step = values.length>1 ? (w - pad*2)/(values.length-1) : w;
            const points = values.map((v,i)=>{
                const x = pad + i*step;
                const y = h - pad - ((v - min) / (max - min || 1)) * (h - pad*2);
                return `${x},${y}`;
            }).join(' ');
            const last = values[values.length-1] || 0;
            const prev = values[values.length-2] || 0;
            const color = last >= prev ? '#16a34a' : '#ef4444';
            return `<svg class="spark" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
                <polyline fill="none" stroke="${color}" stroke-width="2" points="${points}" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
        }

        function renderHighlights(){
            highlightsEl.innerHTML = '';
            const branches = Object.values(branchMap).sort((a,b)=> (b.sales30||0) - (a.sales30||0));
            if (!branches.length) { 
                highlightsEl.innerHTML = '<div class="muted" style="text-align: center; padding: 1rem;">No highlights</div>'; 
                return; 
            }
            const top = branches.slice(0,3);
            top.forEach(b=>{
                const el = document.createElement('div'); 
                el.className='list-item';
                el.innerHTML = `
                    <div>
                        <div style="font-weight:600">${b.displayName}</div>
                        <div class="muted">${fmtZMW(b.sales30)} (30d)</div>
                    </div>
                    <div style="text-align:right">
                        <div class="muted">Growth</div>
                        <div style="font-weight:700;color:${b.growth >= 0 ? '#16a34a' : '#ef4444'}">${b.growth? b.growth.toFixed(1)+'%':'â€”'}</div>
                    </div>
                `;
                highlightsEl.appendChild(el);
            });
        }

        function openWarehouse(e){
            const branch = e.currentTarget.getAttribute('data-branch');
            if (!branch) return;
            window.location.href = `admin-warehouse.html?branch=${encodeURIComponent(branch)}`;
        }
        
        function viewBranch(e){
            const branch = e.currentTarget.getAttribute('data-branch');
            if (!branch) return;
            window.location.href = `admin-warehouse.html?branch=${encodeURIComponent(branch)}#focus`;
        }

        async function downloadGrv(docId){
            try{
                const doc = await db.collection('grvHistory').doc(docId).get();
                if (!doc.exists) { 
                    showMessage('GRV not found', 'error');
                    return; 
                }
                const d = doc.data();
                const rows = [['branch','code','name','category','qty','price','location']];
                (d.items||[]).forEach(i => rows.push([
                    i.branch, i.code, i.name, i.category, i.qty, 
                    (i.price||0).toFixed(2), i.location||''
                ]));
                const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
                const filename = `grv-${new Date((d.processedAt||Date.now())).toISOString().slice(0,19)}.csv`;
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); 
                a.href=url; 
                a.download=filename; 
                document.body.appendChild(a); 
                a.click(); 
                a.remove();
                URL.revokeObjectURL(url);
                showMessage('GRV exported successfully', 'success');
            } catch(e){ 
                showMessage('Error downloading GRV: ' + e.message, 'error');
            }
        }

        // UI wiring
        document.getElementById('filterInput').addEventListener('input', renderGrid);
        document.getElementById('logoutBtn').addEventListener('click', ()=> { 
            localStorage.removeItem('currentUser'); 
            window.location.href='index.html'; 
        });

        // init
        (function init(){
            ['branch1','branch2','branch3'].forEach(id => { 
                if (!branchMap[id]) branchMap[id] = createEmptyBranch(id); 
            });
            startInventoryListener();
            startSalesListener();
            startGrvListener();
            renderAll();
        })();
    </script>
</body>
</html>
